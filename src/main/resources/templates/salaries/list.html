<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout.html}">
<head>
    <meta charset="UTF-8">
    <title>급여 조회</title>
    <style>
        .table td {
            vertical-align: middle;
        }

        #detailBox {
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
        }

        /* 인센티브와 공제 셀 스타일 */
        .incentive-cell, .deduction-cell {
            text-decoration: underline;
            text-decoration-thickness: 1px;
            cursor: pointer;
            font-weight: normal;
            margin-bottom: 20px;
        }

        /* 인센티브 셀 */
        .incentive-cell {
            color: #77b1fb !important;  /* 텍스트 색상만 변경 */
            text-decoration: underline;
            cursor: pointer;
            font-weight: normal;
            margin-bottom: 20px;
        }

        /* 공제 셀 */
        .deduction-cell {
            color: #dc3545 !important;  /* 텍스트 색상만 변경 */
            text-decoration: underline;
            cursor: pointer;
            font-weight: normal;
            margin-bottom: 20px;
        }

        .incentive-cell:hover, .deduction-cell:hover {
            background-color: #f0f8ff;
        }

        .table th {
            font-size: 1.0rem;
            text-align: center;
        }

        .table td {
            font-size: 0.9rem;
            text-align: center;
        }

        /* 총 급여와 실수령액을 굵게 표시 */
        .total-salary, .net-salary {
            font-weight: bold;
        }

        .salary-zone td, .salary-zone th {
            border: 2px solid #000;
        }

        .salary-zone {
            border-collapse: collapse;
        }

    </style>

</head>
<body style="background-color: #f8f9fa;">
<div layout:fragment="content">

    <div class="container mt-4 w-100 bg-light">
        <h2 class="fw-bold mb-4 text-center">급여 조회</h2>

        <div th:if="${salList.content == null or #lists.isEmpty(salList.content)}" class="no-data">
            항목 없음
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <table class="table table-bordered text-company mb-0">
                    <thead class="table-light text-center">
                    <tr>
                        <th>프로필</th>
                        <th>직원번호</th>
                        <th>직원명</th>
                        <th>직책</th>
                        <th>기본급</th>
                        <th>직무수당</th>
                        <th class="incentive-header">인센티브</th>
                        <th class="total-salary">총 급여</th>
                        <th class="deduction-header">공제</th>
                        <th class="net-salary">실수령액</th>
                        <th>급여 지급일</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="salary : ${salList.content}" class="text-center">
                        <td class="profile-cell">
                            <img th:if="${salary.adminDTO.adminProfileMeta != null}"
                                 th:src="@{${salary.adminDTO.adminProfileMeta}}"
                                 style="width: 60px; height: 80px;">
                            <img th:unless="${salary.adminDTO.adminProfileMeta != null}"
                                 th:src="@{/profile/default.png}"
                                 style="width: 60px; height: 80px;">
                        </td>
                        <td th:text="${salary.adminDTO.adminEmployeeNum}">사번</td>
                        <td th:text="${salary.adminDTO.adminName}">이름</td>
                        <td th:text="${salary.salPosition}">직책</td>
                        <td th:text="${salary.salBase}">기본급</td>
                        <td th:text="${salary.salDuty}">직무수당</td>
                        <td class="incentive-cell" th:data-details="${salary.salIncen}">
                            <span class="incentive-total">0</span>
                        </td>
                        <td class="total-salary">0</td>
                        <td class="deduction-cell" th:data-details="${salary.salDedu}">
                            <span class="deduction-total">0</span>
                        </td>
                        <td class="net-salary">0</td>
                        <td th:text="${salary.salDate}">급여 지급일</td>
                    </tr>
                    </tbody>
                </table>
                <div id="detailBox" class="mt-4 p-3 border rounded bg-white" style="display: none;" data-current-cell=""></div>
            </div>

            <!-- 페이징 처리 부분 -->
            <div class="d-flex justify-content-between">
                <button th:if="${salList.hasPrevious()}" class="btn btn-primary">이전</button>
                <button th:if="${salList.hasNext()}" class="btn btn-primary">다음</button>
            </div>
        </div>

    </div>


    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // 기본급과 직무수당 천 단위 포맷팅
            document.querySelectorAll('td:nth-child(2)').forEach(cell => {
                const value = parseFloat(cell.innerText.replace(/,/g, '')) || 0;
                cell.innerText = value.toLocaleString();
            });

            document.querySelectorAll('td:nth-child(3)').forEach(cell => {
                const value = parseFloat(cell.innerText.replace(/,/g, '')) || 0;
                cell.innerText = value.toLocaleString();
            });

            // 인센티브와 공제 합계 계산
            document.querySelectorAll('.incentive-cell').forEach(cell => {
                const details = cell.dataset.details;
                if (details) {
                    const total = details.split(',')
                        .reduce((sum, item) => {
                            const value = parseInt(item.split(':')[1]) || 0;
                            return sum + value;
                        }, 0);
                    cell.querySelector('.incentive-total').textContent = total.toLocaleString();
                }
            });

            document.querySelectorAll('.deduction-cell').forEach(cell => {
                const details = cell.dataset.details;
                if (details) {
                    const total = details.split(',')
                        .reduce((sum, item) => {
                            const value = parseInt(item.split(':')[1]) || 0;
                            return sum + value;
                        }, 0);
                    cell.querySelector('.deduction-total').textContent = total.toLocaleString();
                }
            });

            // 총급여와 실수령액 계산
            const rows = document.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const baseSalary = parseFloat(row.querySelector('td:nth-child(5)').innerText.replace(/,/g, '') || 0);  // 기본급
                const dutySalary = parseFloat(row.querySelector('td:nth-child(6)').innerText.replace(/,/g, '') || 0);  // 직무수당
                const incentive = parseFloat(row.querySelector('.incentive-total').innerText.replace(/,/g, '') || 0);  // 인센티브
                const deductions = parseFloat(row.querySelector('.deduction-total').innerText.replace(/,/g, '') || 0);  // 공제

                // 총 급여는 기본급 + 직무수당 + 인센티브
                const total = baseSalary + dutySalary + incentive;
                // 실수령액은 총 급여 - 공제
                const net = total - deductions;

                row.querySelector('.total-salary').innerText = total.toLocaleString();  // 총 급여 출력
                row.querySelector('.net-salary').innerText = net.toLocaleString();  // 실수령액 출력
            });

        });

        // 상세보기 박스 열기
        function showDetailBox(title, details, cell) {
            const detailBox = document.getElementById('detailBox');

            // 현재 클릭한 셀과 이전에 열렸던 셀 비교
            const currentlyOpen = detailBox.dataset.currentCell === cell.dataset.details;

            if (currentlyOpen) {
                detailBox.style.display = 'none';
                detailBox.innerHTML = '';
                detailBox.dataset.currentCell = '';
                return;
            }

            const items = details.split(',');
            const formattedDetails = items.map(item => {
                const [name, value] = item.split(':');
                return `<div class="mb-1">${name.trim()}: <strong>${parseInt(value).toLocaleString()}원</strong></div>`;
            }).join('');

            detailBox.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="fw-bold mb-0">${title}</h5>
            <button class="btn btn-sm btn-outline-secondary" onclick="hideDetailBox()">닫기</button>
        </div>
        ${formattedDetails}
    `;
            detailBox.style.display = 'block';
            detailBox.dataset.currentCell = cell.dataset.details;

            detailBox.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // 상세보기 박스 숨기기
        function hideDetailBox() {
            const detailBox = document.getElementById('detailBox');
            detailBox.style.display = 'none';
            detailBox.innerHTML = '';
            detailBox.dataset.currentCell = '';
        }

        document.addEventListener('DOMContentLoaded', function () {
            // 클릭 이벤트: 공제와 인센티브
            document.querySelectorAll('.deduction-cell').forEach(cell => {
                cell.addEventListener('click', () => {
                    // 다른 셀에서 강조된 텍스트를 해제
                    document.querySelectorAll('.deduction-cell').forEach(otherCell => {
                        const span = otherCell.querySelector('span');
                        if (span) {
                            span.classList.remove('clicked-text');
                        }
                    });

                    // 현재 클릭한 텍스트 강조
                    const span = cell.querySelector('span');
                    if (span) {
                        span.classList.add('clicked-text');
                    }

                    showDetailBox('공제 상세내역', cell.dataset.details, cell);
                });
            });

            document.querySelectorAll('.incentive-cell').forEach(cell => {
                cell.addEventListener('click', () => {
                    // 다른 셀에서 강조된 텍스트를 해제
                    document.querySelectorAll('.incentive-cell').forEach(otherCell => {
                        const span = otherCell.querySelector('span');
                        if (span) {
                            span.classList.remove('clicked-text');
                        }
                    });

                    // 현재 클릭한 텍스트 강조
                    const span = cell.querySelector('span');
                    if (span) {
                        span.classList.add('clicked-text');
                    }

                    showDetailBox('인센티브 상세내역', cell.dataset.details, cell);
                });
            });
        });


    </script>

</div>

</body>
</html>
