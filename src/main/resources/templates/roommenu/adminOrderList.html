<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout.html}">
<head>
    <meta charset="UTF-8">
    <title>Í¥ÄÎ¶¨Ïûê Ï†ÑÏö© Ï£ºÎ¨∏ ÎÇ¥Ïó≠ Î™©Î°ù</title>
    <style>
        .table td {
            vertical-align: middle;
        }
        .table {
            width: 100%;
            table-layout: fixed;
        }
    </style>
</head>
<body style="background-color: #f8f9fa;">
<div layout:fragment="content">
    <h2 class="fw-bold mb-4 text-center" >Í¥ÄÎ¶¨Ïûê Ï†ÑÏö© Ï£ºÎ¨∏ ÎÇ¥Ïó≠ Î™©Î°ù</h2>
    <div class="d-flex justify-content-center mt-4 gap-3">
        <button type="button" onclick="handleConfirm('ACCEPT')" class="btn btn-warning px-4">Ï£ºÎ¨∏ Ï†ëÏàò</button>
        <button type="button" onclick="handleConfirm('COMPLETE')" class="btn btn-success px-4">Ï£ºÎ¨∏ ÏôÑÎ£å</button>
        <button type="button" onclick="handleConfirm('CANCEL')" class="btn btn-danger px-4">Ï£ºÎ¨∏ Ï∑®ÏÜå</button>
        <button type="button" onclick="location.href='/roommenu/list'" class="btn btn-primary px-3">Î£∏ ÏÑúÎπÑÏä§ Î™©Î°ù</button>
    </div>

    <div class="container mt-4 w-100 bg-light">

        <form id="orderForm">
            <div class="row mt-4">
                <div class="col-12">
                    <table class="table table-bordered text-company mb-0">
                        <thead class="table-light text-center">
                        <tr>
                            <th style="width: 10%;">
                                <input type="checkbox" id="selectAll"> ÏÑ†ÌÉù
                            </th>
                            <th style="width: 10%;">Ï£ºÎ¨∏Î≤àÌò∏</th>
                            <th style="width: 20%;">Ï£ºÎ¨∏Ïûê</th>
                            <th style="width: 10%;">ÏÉÅÌÉú</th>
                            <th style="width: 50%;">Ï£ºÎ¨∏ÎÇ¥Ïö©</th>
                        </tr>
                        </thead>

                        <tbody>
                        <tr th:each="order : ${orders}">
                            <td class="text-center">
                                <!-- Í∞Å Ï≤¥ÌÅ¨Î∞ïÏä§ÏóêÎäî Ï£ºÎ¨∏Î≤àÌò∏Î•º data-id ÏÜçÏÑ±Ïóê Ìï†Îãπ -->
                                <input type="checkbox" th:data-id="${order.roomMenuOrderNum}" />
                            </td>
                            <td th:text="${order.roomMenuOrderNum}" class="text-center">1001</td>
                            <td th:text="${order.member.memberName + ' (' + order.member.memberEmail + ')'}" class="text-center">ÌôçÍ∏∏Îèô</td>
                            <td th:text="${order.roomMenuOrderStatus}" class="text-center">ORDER</td>
                            <td class="text-center" style="vertical-align: middle;">
                                <div class="card-body">
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item"
                                        th:each="item, iterStat : ${order.orderItemList}"
                                        th:if="${iterStat.index == 0}">
                                        <div class="row text-center text-md-start g-1">
                                            <div class="col-12 col-md-6">
                                                <strong th:text="#{orderList.menuName}">Î©îÎâ¥ Ïù¥Î¶Ñ:</strong>
                                                <span th:text="${item.roomMenuOrderItemName}" class="ms-1"></span>
                                            </div>
                                            <div class="col-6 col-md-3">
                                                <strong th:text="#{orderList.quantity}">ÏàòÎüâ:</strong>
                                                <span th:text="${item.roomMenuOrderItemAmount}" class="ms-1"></span>
                                            </div>
                                            <div class="col-12">
                                                <strong>Ï¥ù Ï£ºÎ¨∏ Í∏àÏï°:</strong>
                                                ‚Ç©<span th:text="${#numbers.formatInteger(order.originalTotalPrice, 3, 'COMMA')}"></span>
                                                <span th:if="${order.discountedPrice != null}">
                <br>
                <strong style="color: #f75b5b;">Ìï†Ïù∏ Ï†ÅÏö© Í∏àÏï°:</strong>
                ‚Ç©<span th:text="${#numbers.formatInteger(order.discountedPrice, 3, 'COMMA')}"></span>
            </span>
                                            </div>

                                            <div th:if="${item.roomMenuSelectOptionName != null and item.roomMenuSelectOptionName != ''}"
                                                 class="col-12 text-muted mt-1" style="font-size: 0.9em;">
                                                <small>
                                                    <strong>ÏòµÏÖò:</strong>
                                                    <span th:text="${item.roomMenuSelectOptionName}">ÏòµÏÖò ÏöîÏïΩ Ï†ïÎ≥¥</span>
                                                </small>
                                            </div>
                                        </div>
                                        <div>
                                            <small>
                                                ÏöîÏ≤≠: <span th:text="${item.roomMenuOrderRequestMessage}"></span>
                                            </small>
                                        </div>
                                        </li>
                                    </ul>

                                    <!-- Ï∂îÍ∞Ä Ï£ºÎ¨∏ Ìï≠Î™©Ïù¥ ÏûàÏùÑ Í≤ΩÏö∞, "Ïô∏ XÍ±¥ Ï∂îÍ∞Ä Ï£ºÎ¨∏Îê®"Í≥º ÏÉÅÏÑ∏ Î≤ÑÌäº ÌëúÏãú -->
                                    <div class="mt-2" th:if="${order.orderItemList.size() > 1}">
                                        <small th:text="'Ïô∏ ' + (${order.orderItemList.size()} - 1) + 'Í±¥ Ï∂îÍ∞Ä Ï£ºÎ¨∏Îê®'"></small>
                                        <button type="button" class="btn btn-link" data-bs-toggle="modal"
                                                th:data-bs-target="'#orderModal-' + ${order.roomMenuOrderNum}">
                                            ÏÉÅÏÑ∏Î≥¥Í∏∞
                                        </button>
                                    </div>
                                    <!-- Ï∂îÍ∞Ä Ï£ºÎ¨∏ Ìï≠Î™©Ïù¥ ÏûàÏùÑ Í≤ΩÏö∞, "Ïô∏ XÍ±¥ Ï∂îÍ∞Ä Ï£ºÎ¨∏Îê®"Í≥º ÏÉÅÏÑ∏ Î≤ÑÌäº ÌëúÏãú  ÎÅù-->

                                    <!-- Ï£ºÎ¨∏ ÏÉÅÏÑ∏ Î™®Îã¨Ï∞Ω (ÏöîÏ≤≠ÏÇ¨Ìï≠ Ï†úÍ±∞, ÏµúÏ¢Ö Ï¥ù Í∏àÏï° Ï∂îÍ∞Ä) -->
                                    <div class="modal fade" th:id="'orderModal-' + ${order.roomMenuOrderNum}" tabindex="-1" aria-labelledby="orderModalLabel" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="orderModalLabel">Ï£ºÎ¨∏ ÏÉÅÏÑ∏ Ï†ïÎ≥¥</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Îã´Í∏∞"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <ul class="list-group list-group-flush">
                                                        <!-- Ï£ºÎ¨∏ Ìï≠Î™© Î™©Î°ù Ï†ÑÏ≤¥ Ï∂úÎ†• (ÏöîÏ≤≠ÏÇ¨Ìï≠ÏùÄ ÏÉùÎûµ) -->
                                                        <li class="list-group-item" th:each="item : ${order.orderItemList}">
                                                            <div class="d-flex align-items-center mb-1">
                                                                <strong class="me-2" th:text="#{orderList.menuName}">Î©îÎâ¥ Ïù¥Î¶Ñ:</strong>
                                                                <span th:text="${item.roomMenuOrderItemName}" class="flex-grow-1"></span>
                                                            </div>

                                                            <div th:if="${item.roomMenuSelectOptionName != null and item.roomMenuSelectOptionName != ''}"
                                                                 class="d-flex align-items-center mb-1 text-muted" style="font-size: 0.9em;">
                                                                <strong class="me-2">ÏòµÏÖò:</strong>
                                                                <span th:text="${item.roomMenuSelectOptionName}">ÏòµÏÖò ÏöîÏïΩ Ï†ïÎ≥¥</span>
                                                            </div>
                                                            <div class="d-flex align-items-center mb-1">
                                                                <strong class="me-2" th:text="#{orderList.quantity}">ÏàòÎüâ:</strong>
                                                                <span th:text="${item.roomMenuOrderItemAmount}" class="flex-grow-1"></span>
                                                            </div>
                                                            <div class="d-flex align-items-center">
                                                                <strong class="me-2" th:text="#{orderList.totalPrice}">Ï¥ù Í∞ÄÍ≤©:</strong>
                                                                <span class="flex-grow-1"></span>
                                                                <strong>‚Ç©<span th:text="${#numbers.formatInteger(item.roomMenuOrderItemPrice * item.roomMenuOrderItemAmount, 3, 'COMMA')}">ÏïÑÏù¥ÌÖú Ï¥ù Í∏àÏï°</span></strong>
                                                            </div>
                                                        </li>
                                                    </ul>
                                                </div>
                                                <div class="modal-footer">
                                                    <!-- Î™®Îã¨ ÌïòÎã®Ïóê Ï†ÑÏ≤¥ Ï£ºÎ¨∏Ïùò Ï¥ù Í∏àÏï° ÌëúÏãú -->
                                                    <div class="me-auto">
                                                        <strong>Ï¥ù Ï£ºÎ¨∏ Í∏àÏï°:</strong> ‚Ç©<span th:text="${#numbers.formatInteger(order.originalTotalPrice, 3, 'COMMA')}"></span><br>
                                                        <span th:if="${order.discountedPrice != null}">
                                                        <strong style="color: #f75b5b;">Ìï†Ïù∏ Ï†ÅÏö© ÌõÑ Í∏àÏï°:</strong>
                                                        ‚Ç©<span th:text="${#numbers.formatInteger(order.discountedPrice, 3, 'COMMA')}"></span>
                                                        </span>
                                                    </div>
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Îã´Í∏∞</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Ìï¥Îãπ Ï£ºÎ¨∏Ïùò ÏÉÅÏÑ∏ Î™®Îã¨ (Í∞Å Ï£ºÎ¨∏ÎßàÎã§ ÏÉùÏÑ±) ÎÅù-->
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </form>
    </div>

    <!-- ÏïåÎûå Î™®Îã¨ ÏãúÏûë -->
    <div class="modal fade" id="orderAlertModal" tabindex="-1" aria-labelledby="orderAlertModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title" id="orderAlertModalLabel">üõéÔ∏è ÏÉàÎ°úÏö¥ Ï£ºÎ¨∏ ÏïåÎ¶º</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Îã´Í∏∞"></button>
                </div>
                <div class="modal-body" id="orderAlertContent">
                    <!-- JSÎ°ú Ï±ÑÏõåÏßê -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="orderAlertConfirmBtn">ÌôïÏù∏</button>
                </div>
            </div>
        </div>
    </div>
    <!-- ÏïåÎûå Î™®Îã¨ Ïã§Ìñâ ÎÅù -->

    <!-- ÌéòÏù¥ÏßÄ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò -->
    <nav>
        <ul class="pagination justify-content-center align-items-center mt-3">
            <!-- Ï≤´ ÌéòÏù¥ÏßÄ -->
            <li class="page-item" th:classappend="${currentPage == 1} ? 'disabled'">
                <a class="page-link" th:href="@{/roommenu/adminOrderList(page=0)}">
                    &laquo; Ï≤òÏùå
                </a>
            </li>

            <!-- Ïù¥Ï†Ñ ÌéòÏù¥ÏßÄ -->
            <li class="page-item" th:classappend="${currentPage == 1} ? 'disabled'">
                <a class="page-link" th:href="@{/roommenu/adminOrderList(page=${prevPage - 1})}">
                    Ïù¥Ï†Ñ
                </a>
            </li>

            <!-- ÌéòÏù¥ÏßÄ Î≤àÌò∏ -->
            <li class="page-item"
                th:each="i : ${#numbers.sequence(startPage, endPage)}"
                th:classappend="${i == currentPage} ? 'active'">
                <a class="page-link"
                   th:href="@{/roommenu/adminOrderList(page=${i - 1})}"
                   th:text="${i}">1</a>
            </li>

            <!-- Îã§Ïùå ÌéòÏù¥ÏßÄ -->
            <li class="page-item" th:classappend="${currentPage == totalPages} ? 'disabled'">
                <a class="page-link" th:href="@{/roommenu/adminOrderList(page=${nextPage - 1})}">
                    Îã§Ïùå
                </a>
            </li>

            <!-- ÎßàÏßÄÎßâ ÌéòÏù¥ÏßÄ -->
            <li class="page-item" th:classappend="${currentPage == totalPages} ? 'disabled'">
                <a class="page-link" th:href="@{/roommenu/adminOrderList(page=${totalPages - 1})}">
                    ÎßàÏßÄÎßâ &raquo;
                </a>
            </li>
        </ul>
    </nav>

    <script>
        // ÌéòÏù¥ÏßÄ Î°úÎî© ÌõÑ Ï†ÑÏ≤¥ ÏÑ†ÌÉù Ï≤¥ÌÅ¨Î∞ïÏä§ Ïù¥Î≤§Ìä∏ Îì±Î°ù
        document.addEventListener('DOMContentLoaded', () => {
            const selectAll = document.getElementById('selectAll');
            selectAll.addEventListener('change', function () {
                // tbody ÎÇ¥Ïùò Î™®Îì† Ï≤¥ÌÅ¨Î∞ïÏä§Î•º Í∞ÄÏ†∏ÏôÄÏÑú Ï†ÑÏ≤¥ ÏÑ†ÌÉù Ïó¨Î∂ÄÏóê Îî∞Îùº Ï≤¥ÌÅ¨ ÏÉÅÌÉú Î≥ÄÍ≤Ω
                const checkboxes = document.querySelectorAll('tbody input[type="checkbox"]');
                checkboxes.forEach(chk => {
                    chk.checked = this.checked;
                });
            });
        });

        function handleConfirm(actionType) {
            const checkedOrders = [];

            // tbodyÏùò Î™®Îì† Ï≤¥ÌÅ¨Î∞ïÏä§Î•º ÏàúÌöå
            document.querySelectorAll('tbody input[type="checkbox"]').forEach(checkbox => {
                if (checkbox.checked) {
                    const row = checkbox.closest('tr');
                    const orderIdStr = checkbox.dataset.id;
                    const orderId = parseInt(orderIdStr, 10);

                    if (isNaN(orderId)) {
                        console.error("Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ Ï£ºÎ¨∏Î≤àÌò∏ÏûÖÎãàÎã§: " + orderIdStr);
                    } else {
                        checkedOrders.push(orderId);
                    }

                    // Ï£ºÎ¨∏ Ï†ëÏàò(ACCEPT)Ïù∏ Í≤ΩÏö∞, ÏÉÅÌÉú ÏÖÄ ÏóÖÎç∞Ïù¥Ìä∏ ÌõÑ Ìñâ Ïú†ÏßÄ
                    if (actionType === 'ACCEPT') {
                        const statusCell = row.querySelector("td:nth-child(3)");
                        if (statusCell) {
                            statusCell.textContent = "ACCEPT";
                        }
                    } else {
                        // COMPLETEÎÇò CANCELÏù∏ Í≤ΩÏö∞Ïóî Ìñâ Ï†úÍ±∞
                        row.remove();
                    }
                }
            });

            if (checkedOrders.length === 0) {
                alert("ÏÑ†ÌÉùÎêú Ï£ºÎ¨∏Ïù¥ ÏóÜÏäµÎãàÎã§.");
                return;
            }

            let url = "";
            switch (actionType) {
                case 'COMPLETE': url = '/roommenu/complete-orders'; break;
                case 'CANCEL': url = '/roommenu/cancel-orders'; break;
                case 'ACCEPT': url = '/roommenu/accept-orders'; break;
            }

            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(checkedOrders)
            }).then(res => {
                if (res.ok) {
                    alert("Ï≤òÎ¶¨ÎêòÏóàÏäµÎãàÎã§.");
                } else {
                    alert("Ï≤òÎ¶¨ Ï§ë Ïò§Î•ò Î∞úÏÉù");
                }
            }).catch(error => {
                console.error(error);
                alert("ÏöîÏ≤≠ Ïã§Ìå®: " + error);
            });
        }
    </script>
</div>
</body>
</html>
