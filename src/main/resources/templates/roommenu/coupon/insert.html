<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layoutmobileA.html}" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>쿠폰 발급</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background-color: #f9f9f9; }

        .container {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            background: white;
            padding: 10px;
        }

        .card { border: none; border-radius: 12px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        /* h1 { font-size: 1.75rem; text-align: center; margin-bottom: 1.5rem; color: #333; } */ /* H1 태그가 없으므로 주석 처리 또는 삭제 가능 */
        .card-body .btn { width: 100%; margin-bottom: 0.75rem; }

        #success-message {
            background-color: #007bff;
            color: white;
            border: 1px solid #007bff;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 0.9rem;
            display: none;
            text-align: center;
            white-space: pre-line;
            opacity: 0.8;
        }

        #error-message {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 0.9rem;
            display: none;
            text-align: center;
            white-space: pre-line;
        }

        .btn-outline-blue1, .btn-outline-blue2, .btn-outline-blue3 {
            border-radius: 8px;
            font-weight: bold;
            padding: 10px 0;
            width: 100%;
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }

        .btn-outline-blue1 { background-color: white; color: #4A90E2; border: 2px solid #4A90E2; }
        .btn-outline-blue2 { background-color: white; color: #5CACEB; border: 2px solid #5CACEB; }
        .btn-outline-blue3 { background-color: white; color: #7FB3E6; border: 2px solid #7FB3E6; }

        .btn-outline-blue1 small,
        .btn-outline-blue2 small,
        .btn-outline-blue3 small {
            color: inherit; /* small 태그도 부모 버튼의 색상을 상속하도록 */
        }

        .btn-blue-main {
            background-color: #77b1fb;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            width: 48%; /* 버튼 두개가 한 줄에 적절히 배치되도록 */
            height: 45px;
            font-size: 1rem;
        }

        .btn-group-row {
            display: flex;
            justify-content: space-between; /* 버튼 사이의 공간을 균등하게 배분 */
            gap: 4%; /* 버튼 사이의 간격, 필요에 따라 조절 */
            margin-top: 0.5rem;
        }

        .card-footer {
            background-color: transparent !important; /* important를 사용하여 다른 스타일에 의해 덮어쓰이는 것을 방지 */
            border-top: none !important;
        }

        /* 버튼 hover 효과 제거 (모바일 환경 고려) */
        .btn:hover,
        .btn-blue-main:hover,
        .btn-outline-blue1:hover,
        .btn-outline-blue2:hover,
        .btn-outline-blue3:hover {
            /* background-color 와 color 를 현재 상태로 유지하거나, 미세한 변화만 주도록 설정 */
            /* 예: opacity: 0.9; */
        }

    </style>
</head>
<body>
<div layout:fragment="contentorderA">
    <div class="container">
        <div style="text-align:center; font-size: 1.25rem; font-weight: bold; margin: 1.5rem 0 0.5rem 0; color: #333;">
            쿠폰 발급
        </div>

        <div id="error-message"></div>
        <div id="success-message"></div>

        <div class="card">
            <div class="card-body">
                <div class="mb-3">
                    <label for="email" class="form-label">이메일 입력</label>
                    <input type="email" class="form-control" id="email" placeholder="your@email.com">
                </div>
                <button type="button" class="btn-outline-blue1" onclick="createCoupon('가입쿠폰')">
                    신규 가입 쿠폰 (20% 할인)<br><small style="font-size: 0.7em;">계정당 최초 1개</small>
                </button>
                <button type="button" class="btn-outline-blue2" onclick="createCoupon('멤버쿠폰')">
                    회원 쿠폰 (5% 할인)<br><small style="font-size: 0.7em;">무제한</small>
                </button>
                <button type="button" class="btn-outline-blue3" onclick="createCoupon('이벤트쿠폰')">
                    이벤트 쿠폰 (15% 할인)<br><small style="font-size: 0.7em;">최대 3개</small>
                </button>
            </div>
            <div class="card-footer text-center">
                <div class="btn-group-row">
                    <button type="button" class="btn-blue-main" onclick="fetchAndDisplayMyCoupons()">보유중인 쿠폰</button>
                    <button type="button" class="btn-blue-main" onclick="window.location.href='/roommenu/orderpage'">주문하러 가기</button>
                </div>
            </div>
        </div>

        <div id="myCouponsSection" class="card mt-4" style="display: none;">
            <div class="card-body">
                <h2 class="card-title text-center mb-3">내 쿠폰</h2>
                <ul id="myCouponsList" class="list-group list-group-flush"></ul>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // 쿠폰 타입 한글 <-> 영문 변환 함수들을 전역 스코프로 이동
        function mapCouponType(koreanTypeName) {
            const mapping = {
                "멤버쿠폰": "MEMBER",
                "가입쿠폰": "SIGNUP",
                "이벤트쿠폰": "EVENT"
                // 필요시 다른 쿠폰 타입 추가
            };
            if (!mapping.hasOwnProperty(koreanTypeName)) {
                console.error("알 수 없는 쿠폰 타입(한글):", koreanTypeName);
                return null;
            }
            return mapping[koreanTypeName];
        }

        function getKoreanCouponTypeName(englishTypeName) {
            const mapping = {
                "BIRTHDAY": "생일쿠폰",
                "MEMBER": "멤버쿠폰",
                "SIGNUP": "가입쿠폰",
                "EVENT": "이벤트쿠폰"
                // 필요시 다른 쿠폰 타입 추가
            };
            return mapping[englishTypeName] || englishTypeName; // 매핑되는 값이 없으면 원래 영문명 반환
        }

        function createCoupon(koreanCouponType) {
            const email = document.getElementById('email').value;
            const successMessageDiv = document.getElementById('success-message');
            const errorMessageDiv = document.getElementById('error-message');

            successMessageDiv.style.display = 'none';
            errorMessageDiv.style.display = 'none';

            if (!email) {
                errorMessageDiv.style.display = 'block';
                errorMessageDiv.textContent = "❌ 이메일을 입력해주세요!";
                return;
            }

            const mappedType = mapCouponType(koreanCouponType);
            if (mappedType === null) {
                errorMessageDiv.style.display = 'block';
                errorMessageDiv.textContent = "❌ 알 수 없는 쿠폰 종류입니다.";
                return;
            }

            fetch('/roommenu/coupon/exists', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: email })
            })
                .then(res => {
                    if (!res.ok) {
                        return res.json()
                            .then(err => { throw new Error(err.error || `[오류 ${res.status}] 회원 정보를 확인하지 못했습니다.`); })
                            .catch(() => { throw new Error(`[오류 ${res.status}] 회원 정보를 확인하지 못했습니다.`); });
                    }
                    return res.json();
                })
                .then(data => {
                    if (!data.exists) {
                        errorMessageDiv.innerHTML = "❌ 존재하지 않는 이메일입니다.<br>회원가입 후 이용해주세요.";
                        errorMessageDiv.style.display = 'block';
                        throw new Error("회원 정보 없음");
                    }

                    if (mappedType === 'SIGNUP') {
                        return fetch(`/roommenu/coupon/already-issued?email=${encodeURIComponent(email)}&couponType=${mappedType}`)
                            .then(res => {
                                if (!res.ok) {
                                    return res.json()
                                        .then(err => { throw new Error(err.error || `[오류 ${res.status}] 가입쿠폰 중복 확인 실패`); })
                                        .catch(() => { throw new Error(`[오류 ${res.status}] 가입쿠폰 중복 확인 실패`); });
                                }
                                return res.json();
                            })
                            .then(dupCheck => {
                                if (dupCheck.issued) {
                                    errorMessageDiv.textContent = `❌ '${koreanCouponType}'은 이미 발급받으셨습니다.`;
                                    errorMessageDiv.style.display = 'block';
                                    throw new Error("중복된 가입쿠폰");
                                }
                            });
                    }
                })
                .then(() => {
                    const couponData = {
                        memberEmail: email,
                        couponType: mappedType,
                        expirationDate: new Date(new Date().setDate(new Date().getDate() + 30)).toISOString().split('T')[0]
                    };
                    return fetch('/roommenu/coupon/insert', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(couponData)
                    });
                })
                .then(res => {
                    if (res.ok) {
                        return res.text().then(msg => {
                            successMessageDiv.innerHTML = `✅ '${koreanCouponType}' 발급 완료!<br><small>${msg}</small>`;
                            successMessageDiv.style.display = 'block';
                            fetchAndDisplayMyCoupons(); // 쿠폰 발급 성공 후 목록 자동 갱신
                        });
                    } else {
                        return res.json()
                            .then(err => { throw new Error(err.error || `[오류 ${res.status}] 쿠폰 발급에 실패했습니다.`); })
                            .catch(() => { throw new Error(`최대 3개까지 받을 수 있습니다.`); });
                    }
                })
                .catch(err => {
                    console.error("쿠폰 발급 과정 중 오류:", err);
                    if (!errorMessageDiv.style.display || errorMessageDiv.style.display === 'none') {
                        errorMessageDiv.textContent = `❌ 오류: ${err.message}`;
                        errorMessageDiv.style.display = 'block';
                    }
                    // 이미 특정 오류 메시지가 표시된 경우 (예: 중복 쿠폰, 회원 정보 없음)는 해당 메시지를 유지
                });
        }

        function fetchAndDisplayMyCoupons() {
            const myCouponsSection = document.getElementById('myCouponsSection');
            const couponListUl = document.getElementById('myCouponsList');
            const errorMessageDiv = document.getElementById('error-message'); // 오류 메시지 표시용

            // 이메일 입력 값 확인
            const email = document.getElementById('email').value;
            if (!email) {
                errorMessageDiv.textContent = "❌ 쿠폰을 조회할 이메일을 입력하세요.";
                errorMessageDiv.style.display = 'block';
                // 이미 쿠폰 섹션이 열려있다면 닫지 않고, 메시지만 업데이트
                return;
            }
            errorMessageDiv.style.display = 'none'; // 이메일이 있으면 이전 오류 메시지 숨김

            // 쿠폰 목록 표시/숨김 토글
            if (myCouponsSection.style.display !== 'none') {
                myCouponsSection.style.display = 'none';
                console.log("내 쿠폰 목록 숨김 처리.");
                return;
            }

            fetch(`/roommenu/coupon/list?email=${encodeURIComponent(email)}`)
                .then(res => {
                    if (!res.ok) {
                        return res.json()
                            .then(err => { throw new Error(err.error || `[오류 ${res.status}] 쿠폰 목록을 가져오지 못했습니다.`); })
                            .catch(() => { throw new Error(`[오류 ${res.status}] 쿠폰 목록을 가져오지 못했습니다.`); });
                    }
                    return res.json();
                })
                .then(coupons => {
                    console.log("서버로부터 받은 쿠폰 데이터:", JSON.stringify(coupons, null, 2));

                    couponListUl.innerHTML = ''; // 목록 초기화
                    if (coupons.length === 0) {
                        couponListUl.innerHTML = '<li class="list-group-item text-center text-muted">보유한 쿠폰이 없습니다.</li>';
                    } else {
                        coupons.forEach(coupon => {
                            console.log("개별 쿠폰 객체:", JSON.stringify(coupon));
                            console.log("개별 쿠폰 타입 (서버에서 받은 이름 그대로):", coupon.couponType); // couponType으로 접근

                            const listItem = document.createElement('li');
                            listItem.className = 'list-group-item';
                            listItem.textContent = `${getKoreanCouponTypeName(coupon.couponType)} - 만료일: ${coupon.expirationDate}`;
                            couponListUl.appendChild(listItem);
                        });
                    }
                    myCouponsSection.style.display = 'block';
                    console.log("보유 쿠폰 목록 표시.");
                })
                .catch(err => {
                    console.error("쿠폰 조회 중 오류 발생:", err);
                    couponListUl.innerHTML = `<li class="list-group-item text-center text-danger">쿠폰 정보를 불러오는 중 오류가 발생했습니다.</li>`;
                    myCouponsSection.style.display = 'block'; // 오류 발생 시에도 섹션은 보이도록 처리
                    errorMessageDiv.textContent = `❌ 쿠폰 조회 오류: ${err.message}`;
                    errorMessageDiv.style.display = 'block';
                });
        }
    </script>
</div>
</body>
</html>