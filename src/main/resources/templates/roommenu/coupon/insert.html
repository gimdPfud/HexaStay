<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ì¿ í° ë°œê¸‰ ë°›ê¸°</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        /* ê¸°ì¡´ CSS ìŠ¤íƒ€ì¼ */
        .coupon-container { max-width: 480px; margin: 2rem auto; padding: 1rem; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        h1 { font-size: 1.75rem; text-align: center; margin-bottom: 1.5rem; color: #333; }
        .card-body .btn { width: 100%; margin-bottom: 0.75rem; }


        /* ë‚˜ì˜ ë°œê¸‰ ì¿ í° ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        #myCouponsSection {
            /* .card ë° .mt-4 ìŠ¤íƒ€ì¼ ì‚¬ìš© */
        }
        #myCouponsSection .card-title {
            font-size: 1.5rem;
            border-bottom: 1px solid #eee; /* ì œëª© ì•„ë˜ ì˜…ì€ ì„  */
            padding-bottom: 10px;
        }
        #myCouponsList {
            /* Bootstrap list-group-flush ì‚¬ìš© */
        }
        #myCouponsList .list-group-item {
            /* Bootstrap list-group-item ìŠ¤íƒ€ì¼ ì‚¬ìš© */
            border-bottom: 1px solid #eee; /* ì•„ì´í…œ êµ¬ë¶„ì„  */
            padding: 15px;
        }
        #myCouponsList .list-group-item:last-child {
            border-bottom: none; /* ë§ˆì§€ë§‰ ì•„ì´í…œì€ ì•„ë˜ ì„  ì—†ìŒ */
        }

        #myCouponsList .list-group-item strong {
            /* ë¼ë²¨ ìŠ¤íƒ€ì¼ */
            margin-right: 5px;
            color: #555; /* ë¼ë²¨ ìƒ‰ìƒ */
        }
        #myCouponsList .list-group-item div {
            margin-bottom: 5px; /* ì•„ì´í…œ ë‚´ ê° ì¤„ ì‚¬ì´ ê°„ê²© */
        }
        #myCouponsList .list-group-item div:last-child {
            margin-bottom: 0; /* ë§ˆì§€ë§‰ ì¤„ì€ ê°„ê²© ì—†ìŒ */
        }
        #myCouponsList .list-group-item small {
            display: block;
            margin-top: 5px; /* ì‘ì€ í…ìŠ¤íŠ¸ ìœ„ ê°„ê²© */
            color: #888; /* ì‘ì€ í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
            font-size: 0.8em; /* ì‘ì€ í…ìŠ¤íŠ¸ í¬ê¸° */
        }


    </style>
</head>
<body>
<div class="coupon-container">
    <div class="card">
        <div class="card-body">
            <h1>ì¿ í° ë°œê¸‰ ë°›ê¸°</h1>
            <div class="mb-3">
                <label for="email" class="form-label">ì´ë©”ì¼ ì…ë ¥</label>
                <input type="email" class="form-control" id="email" placeholder="your@email.com">
            </div>
            <button type="button" class="btn btn-success" onclick="createCoupon('ë©¤ë²„ì¿ í°')">
                ğŸ‘¤ ë©¤ë²„ ì¿ í° ë°›ê¸° (5% í• ì¸) <br><small>ë¬´ì œí•œ</small>
            </button>
            <button type="button" class="btn btn-warning" onclick="createCoupon('ê°€ì…ì¿ í°')">
                ğŸ†• ì²«ê°€ì… ì¿ í° ë°›ê¸° (20% í• ì¸) <br><small>ê°€ì…ë‹¹ 1ê°œ</small>
            </button>
            <button type="button" class="btn btn-info" onclick="createCoupon('ì´ë²¤íŠ¸ì¿ í°')">
                ğŸ‰ ì´ë²¤íŠ¸ ì¿ í° ë°›ê¸° (15% í• ì¸) <br><small>ìµœëŒ€ 3ê°œ</small>
            </button>
        </div> <div class="card-footer text-center">
        <button type="button" class="btn btn-secondary" onclick="fetchAndDisplayMyCoupons()">ë‚´ ì¿ í° ë³´ê¸°</button>
    </div>

    </div> <div id="myCouponsSection" class="card mt-4" style="display: none;">
    <div class="card-body">
        <h2 class="card-title text-center mb-3">ë‚˜ì˜ ë°œê¸‰ ì¿ í°</h2>
        <ul id="myCouponsList" class="list-group list-group-flush">
        </ul>
    </div>
</div>

</div> <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // ë²„íŠ¼ì—ì„œ ì „ë‹¬ëœ ì¿ í° íƒ€ì…(í•œê¸€)ì„ enum ìƒìˆ˜(ì˜ë¬¸)ë¡œ ë§¤í•‘í•˜ëŠ” í•¨ìˆ˜
    function mapCouponType(type) {
        const mapping = {
            "ë©¤ë²„ì¿ í°": "MEMBER",
            "ê°€ì…ì¿ í°": "SIGNUP",
            "ì´ë²¤íŠ¸ì¿ í°": "EVENT"
        };
        if (!mapping.hasOwnProperty(type)) {
            console.error("ì•Œ ìˆ˜ ì—†ëŠ” ì¿ í° íƒ€ì…:", type);
            return null;
        }
        return mapping[type];
    }

    // createCoupon í•¨ìˆ˜ (ì´ì „ì— ìˆ˜ì •í•œ ë‚´ìš©)
    function createCoupon(type) { // í• ì¸ìœ¨ íŒŒë¼ë¯¸í„° ì œê±°
        const email = document.getElementById('email').value;
        if (!email) {
            alert("ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            return;
        }

        const mappedType = mapCouponType(type);
        if (mappedType === null) {
            alert("âŒ ì•Œ ìˆ˜ ì—†ëŠ” ì¿ í° íƒ€ì…ì…ë‹ˆë‹¤.");
            return;
        }

        fetch('/roommenu/coupon/exists', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email: email })
        })
            .then(res => {
                if (!res.ok) { return res.json().then(err => { throw new Error(err.error || `íšŒì› í™•ì¸ ì‹¤íŒ¨ (${res.status})`); }); }
                return res.json();
            })
            .then(data => {
                if (!data.exists) {
                    alert("âŒ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì´ë©”ì¼ì…ë‹ˆë‹¤. íšŒì›ë§Œ ì¿ í°ì„ ë°›ì„ ìˆ˜ ìˆì–´ìš”.");
                    return Promise.reject(new Error("íšŒì› ì •ë³´ ì—†ìŒ"));
                }
                if (mappedType === 'SIGNUP') {
                    return fetch(`/roommenu/coupon/already-issued?email=${email}&couponType=${mappedType}`)
                        .then(res => {
                            if (!res.ok) { return res.json().then(err => { throw new Error(err.error || `ì¤‘ë³µ í™•ì¸ ì‹¤íŒ¨ (${res.status})`); }); }
                            return res.json();
                        })
                        .then(dupCheck => {
                            if (dupCheck.issued) {
                                alert("âŒ ì´ë¯¸ ë°œê¸‰ëœ ê°€ì…ì¿ í°ì…ë‹ˆë‹¤.");
                                throw new Error("ì¤‘ë³µëœ ê°€ì…ì¿ í°");
                            }
                            return Promise.resolve();
                        });
                }
                return Promise.resolve();
            })
            .then(() => {
                const couponData = {
                    memberEmail: email,
                    couponType: mappedType, // CouponType enum ìƒìˆ˜ ì´ë¦„ (ì˜ˆ: "SIGNUP")
                    // í• ì¸ìœ¨ì€ ë°±ì—”ë“œì—ì„œ ê²°ì •í•˜ë¯€ë¡œ ì—¬ê¸°ì„œ ë³´ë‚´ì§€ ì•ŠìŒ
                    // ë§Œë£Œì¼ë„ ë°±ì—”ë“œì—ì„œ ê²°ì •í•˜ê²Œ í•˜ëŠ” ê²ƒì´ ë” ì•ˆì „í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì—¬ê¸°ì„œëŠ” ê·¸ëŒ€ë¡œ ë³´ëƒ„)
                    expirationDate: new Date(new Date().setDate(new Date().getDate() + 30)).toISOString().split('T')[0]
                    // isGuest, used, repeatCouponCount, usedTime ë“± DTO í•„ë“œëŠ” ë°±ì—”ë“œ ìš”êµ¬ì‚¬í•­ì— ë”°ë¼ ì¶”ê°€
                };

                return fetch('/roommenu/coupon/insert', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(couponData)
                });
            })
            .then(res => {
                if (res.ok) {
                    return res.text().then(msg => {
                        alert(`âœ… ${type} ë°œê¸‰ ì™„ë£Œ: ${msg}`);
                        // ë°œê¸‰ ì„±ê³µ í›„ ë°œê¸‰ëœ ì¿ í° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                        fetchAndDisplayMyCoupons();
                    });
                } else {
                    return res.json().then(err => {
                        throw new Error(err.error || `ì„œë²„ ì˜¤ë¥˜ (${res.status})`);
                    }).catch(() => {
                        throw new Error(`ì„œë²„ ì˜¤ë¥˜ (${res.status})`);
                    });
                }
            })
            .catch(err => {
                console.error("ì¿ í° ë°œê¸‰ ìµœì¢… ì‹¤íŒ¨ ì²˜ë¦¬:", err);
                const errorMessage = err.message;

                if (errorMessage && errorMessage.includes(" ì¿ í°ì€ ìµœëŒ€ ") && errorMessage.includes("ê°œê¹Œì§€ ë°œê¸‰ ê°€ëŠ¥í•©ë‹ˆë‹¤.")) {
                    alert("âŒ ë°œê¸‰ ì‹¤íŒ¨: " + errorMessage);
                } else if (errorMessage === 'ì¤‘ë³µëœ ê°€ì…ì¿ í°') {
                    alert("âŒ ë°œê¸‰ ì‹¤íŒ¨: ì´ë¯¸ ë°œê¸‰ëœ ê°€ì…ì¿ í°ì…ë‹ˆë‹¤.");
                } else if (errorMessage !== "íšŒì› ì •ë³´ ì—†ìŒ") {
                    alert("âŒ ì¿ í° ë°œê¸‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + errorMessage);
                }
            });
    }


    /* ì¿ í° ì¡°íšŒ ë° í‘œì‹œ í† ê¸€ */
    function fetchAndDisplayMyCoupons() {
        const myCouponsSection = document.getElementById('myCouponsSection');
        const couponListUl = document.getElementById('myCouponsList');

        if (myCouponsSection && myCouponsSection.style.display !== 'none') {
            myCouponsSection.style.display = 'none';
            console.log("ë‚´ ì¿ í° ëª©ë¡ ìˆ¨ê¹€ ì²˜ë¦¬."); // ë””ë²„ê¹… ë¡œê·¸
            return; // ìˆ¨ê¸´ í›„ í•¨ìˆ˜ ì¢…ë£Œ
        }
        // >>> **ì¶”ê°€ëœ ë¡œì§ ë** <<<


        // ëª©ë¡ ì„¹ì…˜ì´ ìˆ¨ê¹€ ìƒíƒœì´ë©´ ì¿ í°ì„ ê°€ì ¸ì™€ì„œ í‘œì‹œí•©ë‹ˆë‹¤.
        console.log("ë‚´ ì¿ í° ëª©ë¡ í‘œì‹œ ìš”ì²­."); // ë””ë²„ê¹… ë¡œê·¸

        const email = document.getElementById('email').value; // ì´ë©”ì¼ ì…ë ¥ í•„ë“œì—ì„œ ì´ë©”ì¼ ê°€ì ¸ì˜¤ê¸°
        if (!email) {
            alert("ì¿ í°ì„ ì¡°íšŒí•  ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        // Fetch coupons
        fetch(`/roommenu/coupon/list?email=${encodeURIComponent(email)}`)
            .then(res => {
                if (!res.ok) {
                    return res.json().then(err => {
                        throw new Error(err.error || `ì„œë²„ ì˜¤ë¥˜ (${res.status})`);
                    }).catch(() => {
                        throw new Error(`ì„œë²„ ì˜¤ë¥˜ (${res.status})`);
                    });
                }
                return res.json();
            })
            .then(coupons => {

                // ì´ì „ ëª©ë¡ ì•„ì´í…œ ëª¨ë‘ ì œê±°
                if (couponListUl) {
                    couponListUl.innerHTML = '';
                }

                // ì¿ í°ì´ ì—†ëŠ” ê²½ìš° ë©”ì‹œì§€ í‘œì‹œ
                if (coupons.length === 0) {
                    if (couponListUl) {
                        couponListUl.innerHTML = '<li class="list-group-item text-center text-muted">ë³´ìœ í•œ ì¿ í°ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
                    }
                    if (myCouponsSection) {
                        myCouponsSection.style.display = 'block'; // ëª©ë¡ ì„¹ì…˜ í‘œì‹œ
                    }
                    console.log("ë³´ìœ  ì¿ í° ì—†ìŒ ë©”ì‹œì§€ í‘œì‹œ."); // ë””ë²„ê¹… ë¡œê·¸
                    return;
                }

                // ì¿ í° ëª©ë¡ ë™ì  ìƒì„±
                if (couponListUl) {
                    coupons.forEach((coupon) => {
                        const listItem = document.createElement('li');
                        listItem.classList.add('list-group-item');

                        const couponTypeName = coupon.couponType ? String(coupon.couponType) : 'ì•Œ ìˆ˜ ì—†ìŒ'; // String() ì‚¬ìš© ë˜ëŠ” í•„ìš”ì‹œ coupon.couponType ë°”ë¡œ ì‚¬ìš©
                        // Optional: ì˜ì–´ Enum ìƒìˆ˜ ì´ë¦„ì„ í•œê¸€ ì´ë¦„ìœ¼ë¡œ ë§¤í•‘í•˜ëŠ” í•¨ìˆ˜ ì‚¬ìš©
                        const couponTypeKoreanName = getKoreanCouponTypeName(couponTypeName);


                        const couponDiscount = coupon.discountRate !== undefined ? coupon.discountRate : 'N/A';
                        const couponIssueDate = coupon.issueDate ? new Date(coupon.issueDate).toLocaleDateString() : 'N/A';
                        const couponExpirationDate = coupon.expirationDate ? new Date(coupon.expirationDate).toLocaleDateString() : 'N/A';

                        const couponUsed = coupon.used !== undefined ? coupon.used : false;
                        // >>> **ìˆ˜ì •: repeatCouponCount í•„ë“œ ì´ë¦„ í™•ì¸** <<<
                        // CouponDTO í•„ë“œ ì´ë¦„ì€ repeatCouponCount ì…ë‹ˆë‹¤.
                        const couponRepeatCount = coupon.repeatCouponCount !== undefined && coupon.repeatCouponCount !== null ? coupon.repeatCouponCount : 'N/A';


                        // ì‚¬ìš© ìƒíƒœ ë¬¸ìì—´ ê²°ì •
                        let statusText = 'ì•Œ ìˆ˜ ì—†ìŒ';
                        if (couponUsed) {
                            statusText = 'âœ… ì‚¬ìš©ë¨';
                        } else if (couponExpirationDate !== 'N/A' && new Date(couponExpirationDate) < new Date()) { // ë§Œë£Œì¼ ë³€ìˆ˜ ì‚¬ìš©
                            statusText = 'ë§Œë£Œë¨';
                        } else {
                            statusText = 'âŒ ë¯¸ì‚¬ìš©';
                            // ë°˜ë³µ ì¿ í°ì´ê³  ë‚¨ì€ íšŸìˆ˜ê°€ 0ë³´ë‹¤ í¬ê³  ë¯¸ì‚¬ìš© ìƒíƒœì¼ ë•Œë§Œ ë‚¨ì€ íšŸìˆ˜ í‘œì‹œ
                            if (couponRepeatCount !== 'N/A' && couponRepeatCount > 0 && !couponUsed) {
                                statusText += ` (${couponRepeatCount}íšŒ ë‚¨ìŒ)`;
                            }
                        }


                        // ëª©ë¡ ì•„ì´í…œ ë‚´ë¶€ HTML êµ¬ì„±
                        let itemHtml = `
                            <div>
                                 <strong>íƒ€ì…:</strong> ${couponTypeKoreanName} </div>
                            <div>
                                 <strong>í• ì¸ìœ¨:</strong> ${couponDiscount}%
                            </div>
                            <div>
                                 <strong>ìƒíƒœ:</strong> ${statusText}
                            </div>
                        `;

                        if (couponExpirationDate !== 'N/A') {
                            itemHtml += `
                                 <div>
                                      <strong>ë§Œë£Œì¼:</strong> ${couponExpirationDate}
                                 </div>
                             `;
                        }
                        if (coupon.couponNum !== undefined) {
                            itemHtml += `
                                 <div>
                                      <small class="text-muted">ì¿ í° ë²ˆí˜¸: ${coupon.couponNum}</small>
                                 </div>
                             `;
                        }

                        // ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œì— HTML ì„¤ì • í›„ ëª©ë¡ì— ì¶”ê°€
                        listItem.innerHTML = itemHtml;
                        couponListUl.appendChild(listItem);
                    });
                }


                // ëª©ë¡ ì„¹ì…˜ í‘œì‹œ
                if (myCouponsSection) {
                    myCouponsSection.style.display = 'block';
                }
                console.log(`${coupons.length}ê°œ ì¿ í° ëª©ë¡ í‘œì‹œ ì™„ë£Œ.`); // ë””ë²„ê¹… ë¡œê·¸
            })
            .catch(err => {
                console.error("ì¿ í°ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:", err);
                alert("âŒ ì¿ í°ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err.message);

                // ëª©ë¡ ì„¹ì…˜ í‘œì‹œ ë° ì˜¤ë¥˜ ë©”ì‹œì§€ ì•„ì´í…œ ì¶”ê°€
                if (myCouponsSection && couponListUl) {
                    myCouponsSection.style.display = 'block';
                    couponListUl.innerHTML = `<li class="list-group-item text-center text-danger">ì˜¤ë¥˜ ë°œìƒ: ${err.message}</li>`;
                }
            });
    }

    function getKoreanCouponTypeName(englishName) {
        const mapping = {
            "BIRTHDAY": "ìƒì¼ì¿ í°",
            "MEMBER": "ë©¤ë²„ì¿ í°",
            "SIGNUP": "ê°€ì…ì¿ í°",
            "EVENT": "ì´ë²¤íŠ¸ì¿ í°"
        };
        return mapping[englishName] || englishName;
    }


</script>
</body>
</html>