
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëª¨ë°”ì¼ ì£¼ë¬¸ í˜ì´ì§€</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background-color: #f9f9f9; }

        .container {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            background: white;
            padding: 10px;
        }

        .header {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            font-size: 20px;
            border-bottom: 2px solid #ddd;
        }

        .food-list { list-style: none; padding: 10px; }
        .food-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #ddd;
            position: relative;
        }
        .food-info { flex-grow: 1; }
        .food-info p { margin: 2px 0; }

        .request-section {
            margin-top: 20px;
            text-align: left;
        }

        .request-section label {
            font-size: 16px;
            margin-bottom: 5px;
            display: block;
        }

        .request-section textarea {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            height: 100px;
            border-radius: 5px;
            border: 1px solid #ddd;
            resize: none;
        }

        /* í• ì¸ê¸ˆì•¡ê³¼ ìµœì¢…ê²°ì œê¸ˆì•¡ í‘œì‹œ */
        .pricing-section {
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
        }

        .pricing-section div {
            font-size: 16px;
        }

        .pricing-section .discount {
            color: red;
        }

        .pricing-section .final-total {
            font-weight: bold;
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }

        .add-to-cart-btn {
            background-color: #ffeb3b;
            color: black;
        }

        .add-to-cart-btn:hover {
            background-color: #fdd835;
        }

        .back-btn {
            background-color: #ddd;
            color: black;
        }

        .back-btn:hover {
            background-color: #ccc;
        }

        /* ë²„íŠ¼ ì „ì²´ ì»¨í…Œì´ë„ˆ ì •ë ¬ */
        .button-container {
            display: flex;
            flex-direction: column; /* ì„¸ë¡œ ë°°ì¹˜ */
            gap: 6px;
            align-items: flex-start;
            margin-top: 10px;
        }

        /* ê³µí†µ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .mini-btn {
            padding: 6px 12px;
            font-size: 13px;
            font-weight: 500;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        /* ìˆ˜ëŸ‰ ë³€ê²½ ë²„íŠ¼ - ì´ˆë¡ */
        .update-btn {
            background-color: #4CAF50;
            color: white;
        }

        .update-btn:hover {
            background-color: #45a049;
        }

        /* ì‚­ì œ ë²„íŠ¼ - ë¹¨ê°• */
        .delete-btn {
            background-color: #f44336;
            color: white;
        }

        .delete-btn:hover {
            background-color: #e53935;
        }
        .cart-image {
            margin-right: 20px;
        }

        .cart-img {
            width: 100px;
            height: 100px;
            border-radius: 6px;
        }
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            display: none;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.4);
            z-index: 999;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 300px;
            text-align: center;
        }

        .modal-content h3 {
            margin-bottom: 15px;
            font-size: 18px;
        }

        .modal-content input {
            width: 100%;
            padding: 8px;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .modal-buttons button {
            margin: 0 5px;
            padding: 6px 12px;
            font-size: 14px;
            cursor: pointer;
        }

    </style>
</head>
<body>
<!---------------------------------------------------------
*
* HTMLëª…    : cartlist.html
* ê¸°ëŠ¥      : ëª¨ë°”ì¼ í™˜ê²½ì—ì„œ ë£¸ì„œë¹„ìŠ¤ ì£¼ë¬¸ì„ ìœ„í•œ ì¥ë°”êµ¬ë‹ˆ í˜ì´ì§€
*             - ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸´ ìŒì‹ ëª©ë¡ ì¡°íšŒ ë° ì¶œë ¥
*             - ìˆ˜ëŸ‰ ë³€ê²½ ë° ì‚­ì œ ê¸°ëŠ¥ ì œê³µ (AJAX ì—°ë™)
*             - ìš”ì²­ì‚¬í•­ ì…ë ¥ ë° ê²°ì œ ë°©ì‹ ì„ íƒ (í˜„ê¸ˆ / ì¹´ë“œ)
*             - ìµœì¢… ê²°ì œ ê¸ˆì•¡ ê³„ì‚° ë° í‘œì‹œ
* ì‘ì„±ì    : ê¹€ìœ¤ê²¸
* ì‘ì„±ì¼    : 2025-04-05
* ìˆ˜ì •ì¼    : 2025-04-13
*
-------------------------------------------------------------->
<!-- ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆëŠ” ê²½ìš° -->
<div th:if="${isCartEmpty}" class="container" style="text-align:center; padding: 50px; color: #888;">
    <p>ì›¹ì—ì„œ ì£¼ë¬¸</p>
    ğŸ›’ ì¥ë°”êµ¬ë‹ˆì˜<br> ì•„ì´í…œì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤
</div>

<!-- ì¥ë°”êµ¬ë‹ˆì— ì•„ì´í…œì´ ìˆëŠ” ê²½ìš°ë§Œ ì•„ë˜ ë‚´ìš© ì¶œë ¥ -->
<div th:unless="${isCartEmpty}" class="container">
    <!-- í—¤ë” -->
    <div class="header">
        <div>ì£¼ë¬¸</div>
    </div>


    <!-- ë©”ë‰´ ë¦¬ìŠ¤íŠ¸: ë™ì ìœ¼ë¡œ ë©”ë‰´ ì•„ì´í…œ ì¶œë ¥ -->
    <ul class="food-list">
        <li th:each="roomMenuCartDTO : ${cartDetailDTOList}"
            class="food-item"
            th:attr="data-item-id=${roomMenuCartDTO.roomMenuCartDetailNum}">


            <div class="food-info col-6">
                <p>ê°€ê²©: <span class="item-price" th:text="${roomMenuCartDTO.roomMenuCartDetailMenuItemPrice}"></span>ì›</p>
                <p>ìˆ˜ëŸ‰: <span class="item-quantity" th:text="${roomMenuCartDTO.roomMenuCartDetailMenuItemAmount}"></span></p>
                <th:block th:with="totalPrice=${roomMenuCartDTO.roomMenuCartDetailMenuItemPrice * roomMenuCartDTO.roomMenuCartDetailMenuItemAmount}">
                    <p>
                        ì´ ê¸ˆì•¡:
                        <span class="item-total"
                              th:text="${#numbers.formatDecimal(totalPrice, 0, 'COMMA', 0, 'POINT')}"></span>ì›
                    </p>
                </th:block>
            </div>
            <div class="col-4 cart-image"> <!-- ì´ë¯¸ì§€ ì‹œì‘ -->
                <img th:if="${roomMenuCartDTO.roomMenuImageMeta != null}"
                     th:src="@{${roomMenuCartDTO.roomMenuImageMeta}}"
                     class="cart-img">

                <img th:unless="${roomMenuCartDTO.roomMenuImageMeta != null}"
                     th:src="@{/profile/default.png}"
                     class="cart-img">
            </div>
            <!-- ì´ë¯¸ì§€ ë -->

            <!-- ìˆ˜ëŸ‰ë³€ê²½, ì¥ë°”êµ¬ë‹ˆ ì‚­ì œ ì‹œì‘ -->
            <div class="col-2 button-container">
                <button class="mini-btn delete-btn">ì‚­ì œ</button>
                <button class="mini-btn update-btn">ìˆ˜ëŸ‰ ë³€ê²½</button>
            </div>
            <!-- ìˆ˜ëŸ‰ë³€ê²½, ì¥ë°”êµ¬ë‹ˆ ì‚­ì œ ë -->
        </li>
    </ul>

<!--    &lt;!&ndash; í˜„ê¸ˆìœ¼ë¡œ ê²°ì œí•˜ê¸° ì²´í¬ë°•ìŠ¤ ì‹œì‘ &ndash;&gt;-->
<!--    <div class="payment-option">-->
<!--        <label>-->
<!--            <input type="checkbox" id="cashPaymentCheckbox">-->
<!--            í˜„ê¸ˆìœ¼ë¡œ ê²°ì œ-->
<!--        </label>-->
<!--    </div>-->
<!--    &lt;!&ndash; í˜„ê¸ˆìœ¼ë¡œ ê²°ì œí•˜ê¸° ì²´í¬ë°•ìŠ¤ ë &ndash;&gt;-->


    <!-- ìš”ì²­ì‚¬í•­ ì…ë ¥ ì„¹ì…˜ -->
    <div class="request-section">
        <label for="request-input">ìš”ì²­ì‚¬í•­</label>
        <textarea id="request-input" placeholder="ìš”ì²­ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
    </div>

    <!-- í• ì¸ê¸ˆì•¡ê³¼ ìµœì¢…ê²°ì œê¸ˆì•¡ í‘œì‹œ -->
    <div class="pricing-section">
        <div class="discount">í• ì¸ê¸ˆì•¡: 0ì›</div>
        <div class="final-total">ìµœì¢…ê²°ì œê¸ˆì•¡: 0ì›</div>
    </div>

    <!-- ê²°ì œí•˜ê¸° ë° ëª©ë¡ìœ¼ë¡œ ë²„íŠ¼ -->
    <button class="btn add-to-cart-btn" onclick="processPayment()">ê²°ì œí•˜ê¸°</button>
    <button class="btn back-btn" onclick="goToOrderPage()">ëª©ë¡ìœ¼ë¡œ</button>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>


    // ----- ì´ ê²°ì œ ê¸ˆì•¡ì„ ê³„ì‚°í•´ì£¼ëŠ” ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘ ----
    document.addEventListener('DOMContentLoaded', function () {
        const totalSpans = document.querySelectorAll('.item-total');
        let total = 0;

        totalSpans.forEach(span => {
            const value = parseInt(span.textContent.replace(/[^0-9]/g, ''), 10);
            if (!isNaN(value)) {
                total += value;
            }
        });

        // ì´ ê¸ˆì•¡ì„ "ìµœì¢…ê²°ì œê¸ˆì•¡" ì˜ì—­ì— í‘œì‹œ
        const finalTotalEl = document.querySelector('.final-total');
        if (finalTotalEl) {
            finalTotalEl.textContent = `ìµœì¢…ê²°ì œê¸ˆì•¡: ${total.toLocaleString()}ì›`;
        }
    });
    // ----- ì´ ê²°ì œ ê¸ˆì•¡ì„ ê³„ì‚°í•´ì£¼ëŠ” ìŠ¤í¬ë¦½íŠ¸ ë ----


    // ----- ëª©ë¡ìœ¼ë¡œ ì´ë™ì‹œí‚¤ê¸° ì‹œì‘ ----

        function goToOrderPage() {
        // íŠ¹ì • URLë¡œ ì´ë™í•˜ê¸°
        window.location.href = "/roommenu/orderpage";  // ëª©ë¡ í˜ì´ì§€ë¡œ ì´ë™
    }

    // ----- ëª©ë¡ìœ¼ë¡œ ì´ë™ì‹œí‚¤ê¸° ë ----

    // ----- ìŒì‹ ì•„ì´í…œì˜ ìˆ˜ëŸ‰ì„ ë™ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•˜ëŠ” ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ê¸° ì‹œì‘ ----
    let currentItem = null;

    document.addEventListener('DOMContentLoaded', function () {
        const modal = document.getElementById('quantityModal');
        const input = document.getElementById('modalQuantityInput');
        const confirmBtn = document.getElementById('modalConfirmBtn');
        const cancelBtn = document.getElementById('modalCancelBtn');

        let currentItem = null;

        // âœ… ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë‹¬ ë‹«ê¸°
        cancelBtn.addEventListener('click', function () {
            modal.style.display = 'none';
        });

        // âœ… ìˆ˜ëŸ‰ ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì‹œ
        document.querySelectorAll('.update-btn').forEach(button => {
            button.addEventListener('click', function () {
                currentItem = button.closest('.food-item');
                const qtySpan = currentItem.querySelector('.item-quantity');
                const newQty = parseInt(qtySpan.textContent) || 1;

                input.value = newQty;
                modal.style.display = 'flex';
            });
        });

        // âœ… í™•ì¸ ë²„íŠ¼ì€ ì˜¤ì§ í•œ ë²ˆë§Œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        confirmBtn.addEventListener('click', function () {
            if (!currentItem) return;

            const updatedQty = parseInt(input.value);

            if (!updatedQty || updatedQty < 1) {
                alert("ìˆ˜ëŸ‰ì€ 1 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
                return;
            }

            const availableStock = parseInt(currentItem.dataset.stock);
            if (updatedQty > availableStock) {
                alert("ìˆ˜ëŸ‰ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. í˜„ì¬ ì¬ê³ ëŠ” " + availableStock + "ê°œ ì…ë‹ˆë‹¤.");
                return;
            }

            const itemId = currentItem.dataset.itemId;

            $.ajax({
                url: `/roommenu/orderpage/read/${itemId}/${updatedQty}`,
                type: 'PUT',
                success: function () {
                    console.log(`ìˆ˜ëŸ‰ ${updatedQty}ê°œë¡œ ë³€ê²½ ì„±ê³µ`);

                    currentItem.querySelector('.item-quantity').textContent = updatedQty;

                    const price = parseInt(currentItem.querySelector('.item-price').textContent.replace(/[^0-9]/g, ''), 10);
                    const totalElement = currentItem.querySelector('.item-total');
                    const newTotal = updatedQty * price;
                    totalElement.textContent = newTotal.toLocaleString();

                    updateFinalTotal();
                },
                error: function (jqXHR) {
                    if (jqXHR.status === 401) {
                        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                        window.location.href = "/member/login";
                    } else if (jqXHR.status === 403) {
                        alert("í•´ë‹¹ í•­ëª©ì— ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
                    } else {
                        alert("ìˆ˜ëŸ‰ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                        console.error(jqXHR.responseText);
                    }
                }
            });

            modal.style.display = 'none';
        });
    // ----- ìŒì‹ ì•„ì´í…œì˜ ìˆ˜ëŸ‰ì„ ë™ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•˜ëŠ” ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ê¸° ìˆ˜ì • ë ----

        // ----- ì‚­ì œí•˜ê¸° ì‹œì‘ ----
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', function () {
                const item = button.closest('.food-item');

                if (!item) {
                    alert("ì‚­ì œí•  í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }

                const itemId = item.getAttribute('data-item-id');

                if (!itemId) {
                    alert("ì•„ì´í…œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }

                if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

                $.ajax({
                    url: `/roommenu/roomMenuCartItemDelete/${itemId}`,
                    type: 'DELETE',
                    success: function () {
                        alert("ì•„ì´í…œì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                        item.remove();
                        updateFinalTotal();
                        // â­ ì‚­ì œ í›„ ë‚¨ì€ ì•„ì´í…œì´ ì—†ìœ¼ë©´ ë©”ì‹œì§€ ë³´ì—¬ì£¼ê¸°
                        // ì‚­ì œ?
                        const remainingItems = document.querySelectorAll('.food-item');
                        if (remainingItems.length === 0) {
                            const emptyMsg = document.createElement('div');
                            emptyMsg.textContent = 'ğŸ›’ ì¥ë°”êµ¬ë‹ˆì˜ ì•„ì´í…œì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                            emptyMsg.style.textAlign = 'center';
                            emptyMsg.style.padding = '50px';
                            emptyMsg.style.color = '#888';
                            emptyMsg.setAttribute('id', 'emptyCartMsg');

                            document.querySelector('.container').appendChild(emptyMsg);

                            // ê²°ì œ ë²„íŠ¼ ë“± ìˆ¨ê¸°ê¸°
                            document.querySelector('.add-to-cart-btn').style.display = 'none';
                            document.querySelector('.back-btn').style.display = 'none';
                            document.querySelector('.pricing-section').style.display = 'none';
                            document.querySelector('.request-section').style.display = 'none';
                            document.querySelector('.payment-option').style.display = 'none';
                        }
                    },
                    error: function (jqXHR) {
                        if (jqXHR.status === 401) {
                            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                            window.location.href = "/member/login";
                        } else if (jqXHR.status === 403) {
                            alert("í•´ë‹¹ í•­ëª©ì— ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
                        } else {
                            alert("ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                            console.error(jqXHR.responseText);
                        }
                    }
                });
            });
        });
        // ----- ì‚­ì œí•˜ê¸° ë ----

        // ----- ê²°ì œí•˜ê¸° ìµœì¢… ê²°ì œ ê¸ˆì•¡ì„ ì—…ë°ì´íŠ¸ ì‹œì‘ ----
        function updateFinalTotal() {
            let total = 0;
            document.querySelectorAll('.item-total').forEach(span => {
                const value = parseInt(span.textContent.replace(/[^0-9]/g, ''), 10);
                if (!isNaN(value)) total += value;
            });
            document.querySelector('.final-total').textContent = `ìµœì¢…ê²°ì œê¸ˆì•¡: ${total.toLocaleString()}ì›`;
        }

        updateFinalTotal();
    });
    // ----- ê²°ì œí•˜ê¸° ìµœì¢… ê²°ì œ ê¸ˆì•¡ì„ ì—…ë°ì´íŠ¸ ë ----

    // ê²°ì œì—¬ë¶€ì— ë”°ë¼ì„œ ì´ë™ë˜ëŠ” í˜ì´ì§€
    function processPayment() {
        const roomMenuOrderRequestMessage = document.getElementById('request-input').value;

        fetch('/roommenu/cart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({
                requestMessage: roomMenuOrderRequestMessage
            })
        })
            .then(res => res.text())
            .then(result => {
                alert("ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                window.location.href = '/roommenu/orderList';
            })
            .catch(error => {
                alert("ê²°ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + error);
            });
    }



</script>

<!-- ëª¨ë‹¬ì°½ íŒì—… ì‹œì‘ -->
<div id="quantityModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <h3>ìˆ˜ëŸ‰ ë³€ê²½</h3>
        <input type="number" id="modalQuantityInput" min="1" value="1">
        <div class="modal-buttons">
            <button id="modalConfirmBtn">í™•ì¸</button>
            <button id="modalCancelBtn">ì·¨ì†Œ</button>
        </div>
    </div>
</div>
<!-- ëª¨ë‹¬ì°½ íŒì—… ë -->

</body>
</html>
