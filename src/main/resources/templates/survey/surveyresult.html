<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>설문조사 결과</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; font-family: 'Noto Sans KR', sans-serif; }
        .result-container { max-width: 900px; margin: 40px auto; background: #fff; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); padding: 32px; }
        .result-title { color: #1D6F42; font-weight: 700; margin-bottom: 24px; }
        .stat-table th, .stat-table td { text-align: center; }
        .stat-table th { background: #f1f3f5; }
        .stat-table { margin-bottom: 32px; }
        .participant-table th, .participant-table td { text-align: center; }
        .participant-table th { background: #e9ecef; }
        .participant-table { font-size: 0.97rem; }
        .no-data { color: #888; text-align: center; padding: 40px 0; }
    </style>
</head>
<body>
<div class="result-container">
    <h2 class="result-title" th:text="${survey.surveyTitle}">설문조사 제목</h2>
    <div class="mb-4">
        <strong>설문 설명:</strong> <span th:utext="${survey.surveyContent}">설문 설명</span>
    </div>
    <div class="mb-4">
        <strong>참여 인원:</strong> <span th:text="${participantCount}">0</span>명
    </div>
    <table class="table table-bordered stat-table">
        <thead>
        <tr>
            <th>전체 평균</th>
            <th>청결도</th>
            <th>직원 친절도</th>
            <th>체크인/아웃</th>
            <th>시설</th>
            <th>음식</th>
            <th>가성비</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td id="avgTotal">0.00</td>
            <td id="avgCleanliness">0.00</td>
            <td id="avgStaff">0.00</td>
            <td id="avgCheckInOut">0.00</td>
            <td id="avgFacility">0.00</td>
            <td id="avgFood">0.00</td>
            <td id="avgValue">0.00</td>
        </tr>
        </tbody>
    </table>

    <h4 class="mt-5 mb-3">참여자 리스트</h4>
    <div th:if="${#lists.isEmpty(responses)}" class="no-data">
        참여자가 없습니다.
    </div>
    <table class="table table-striped table-bordered participant-table" th:if="${!#lists.isEmpty(responses)}">
        <thead>
        <tr>
            <th>이름(이메일)</th>
            <th>객실명</th>
            <th>청결도</th>
            <th>직원</th>
            <th>체크인/아웃</th>
            <th>시설</th>
            <th>음식</th>
            <th>가성비</th>
            <th>코멘트</th>
            <th>제출일</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="r : ${responses}">
            <td th:text="${r.member != null ? r.member.memberName + ' (' + r.memberEmail + ')' : '-'}">이메일(이름)</td>
            <td th:text="${r.room != null && r.room.hotelRoom != null ? r.room.hotelRoom.hotelRoomName : '-'}">객실명</td>
            <td th:text="${r.surveyResultCleanliness}">0</td>
            <td th:text="${r.surveyResultStaff}">0</td>
            <td th:text="${r.surveyResultCheckInOut}">0</td>
            <td th:text="${r.surveyResultFacility}">0</td>
            <td th:text="${r.surveyResultFood}">0</td>
            <td th:text="${r.surveyResultValue}">0</td>
            <td th:text="${r.surveyResultComment}">-</td>
            <td th:text="${#temporals.format(r.surveyResultSubmittedAt, 'yyyy-MM-dd HH:mm')}">-</td>
        </tr>
        </tbody>
    </table>
</div>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        // JS로 평균 점수 계산
        calculateAverages();
    });

    function calculateAverages() {
        // responses 데이터를 Thymeleaf에서 가져옴
        const responses = /*[[${responses}]]*/ [];
        
        if (responses.length === 0) {
            return;
        }
        
        // 각 항목별 합계
        let totalCleanliness = 0;
        let totalStaff = 0;
        let totalCheckInOut = 0;
        let totalFacility = 0;
        let totalFood = 0;
        let totalValue = 0;
        let validCountCleanliness = 0;
        let validCountStaff = 0;
        let validCountCheckInOut = 0;
        let validCountFacility = 0;
        let validCountFood = 0;
        let validCountValue = 0;
        
        // 각 응답의 점수를 합산
        responses.forEach(response => {
            if (response.surveyResultCleanliness) {
                totalCleanliness += response.surveyResultCleanliness;
                validCountCleanliness++;
            }
            if (response.surveyResultStaff) {
                totalStaff += response.surveyResultStaff;
                validCountStaff++;
            }
            if (response.surveyResultCheckInOut) {
                totalCheckInOut += response.surveyResultCheckInOut;
                validCountCheckInOut++;
            }
            if (response.surveyResultFacility) {
                totalFacility += response.surveyResultFacility;
                validCountFacility++;
            }
            if (response.surveyResultFood) {
                totalFood += response.surveyResultFood;
                validCountFood++;
            }
            if (response.surveyResultValue) {
                totalValue += response.surveyResultValue;
                validCountValue++;
            }
        });
        
        // 평균 계산 (유효한 데이터만 계산)
        const avgCleanliness = validCountCleanliness > 0 ? totalCleanliness / validCountCleanliness : 0;
        const avgStaff = validCountStaff > 0 ? totalStaff / validCountStaff : 0;
        const avgCheckInOut = validCountCheckInOut > 0 ? totalCheckInOut / validCountCheckInOut : 0;
        const avgFacility = validCountFacility > 0 ? totalFacility / validCountFacility : 0;
        const avgFood = validCountFood > 0 ? totalFood / validCountFood : 0;
        const avgValue = validCountValue > 0 ? totalValue / validCountValue : 0;
        
        // 유효한 카테고리 수 계산
        const validCategories = [
            validCountCleanliness > 0, 
            validCountStaff > 0, 
            validCountCheckInOut > 0, 
            validCountFacility > 0, 
            validCountFood > 0, 
            validCountValue > 0
        ].filter(Boolean).length;
        
        // 전체 평균 (유효한 카테고리 평균만 계산)
        const avgTotal = validCategories > 0 ? 
            (avgCleanliness + avgStaff + avgCheckInOut + avgFacility + avgFood + avgValue) / validCategories : 0;
        
        // 계산된 값을 테이블에 표시
        document.getElementById('avgTotal').textContent = avgTotal.toFixed(2);
        document.getElementById('avgCleanliness').textContent = avgCleanliness.toFixed(2);
        document.getElementById('avgStaff').textContent = avgStaff.toFixed(2);
        document.getElementById('avgCheckInOut').textContent = avgCheckInOut.toFixed(2);
        document.getElementById('avgFacility').textContent = avgFacility.toFixed(2);
        document.getElementById('avgFood').textContent = avgFood.toFixed(2);
        document.getElementById('avgValue').textContent = avgValue.toFixed(2);
    }
</script>
</body>
</html>