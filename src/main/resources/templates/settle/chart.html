<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout.html}">
<head>
    <meta charset="UTF-8">
    <title>Ïû¨Î¨¥ Ï†ïÏÇ∞ Ï∞®Ìä∏</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        .chart-section {
            background: #f8f9fa;
            border-radius: 10px;
        }

        .form-select {
            margin: 10px;
        }

        .download-btn {
            font-size: 0.9rem;
        }

        table {
            font-size: 0.9rem;
        }

        table td {
            font-size: 0.81rem !important;
        }

        table td input {
            font-size: 0.81rem !important;
            text-align: center;
        }

        canvas {
            background-color: #fff;
            border-radius: 10px;
        }
    </style>
</head>
<body style="background-color: #f8f9fa;">
<div layout:fragment="content" >

    <div class="container mt-4 w-100 bg-light">
        <h2 class="fw-bold mb-4 text-center">Ïû¨Î¨¥ Ï†ïÏÇ∞ Ï∞®Ìä∏</h2>

        <!-- üîΩ ÏÑ†ÌÉù ÌïÑÌÑ∞ + Îã§Ïö¥Î°úÎìú Î≤ÑÌäº -->
        <div class="row align-items-center mb-4 gx-3 gy-2">
            <!-- ÌïÑÌÑ∞Îì§ -->
            <div class="col-lg-10 col-md-12 d-flex flex-wrap align-items-center gap-2">
                <select class="form-select" id="hqSelect" style="width: 200px; height: 40px; font-size: 0.9rem;">
                    <option selected>Î≥∏ÏÇ¨ ÏÑ†ÌÉù</option>
                    <option>ÏÑúÏö∏Î≥∏ÏÇ¨</option>
                    <option>Î∂ÄÏÇ∞Î≥∏ÏÇ¨</option>
                </select>
                <select class="form-select" id="branchSelect" style="width: 200px; height: 40px; font-size: 0.9rem;">
                    <option selected>ÏßÄÏÇ¨ ÏÑ†ÌÉù</option>
                    <option>Ï§ëÎ∂ÄÏßÄÏÇ¨</option>
                    <option>ÎÇ®Î∂ÄÏßÄÏÇ¨</option>
                </select>
                <select class="form-select" id="officeSelect" style="width: 200px; height: 40px; font-size: 0.9rem;">
                    <option selected>ÏßÄÏ†ê ÏÑ†ÌÉù</option>
                    <option>Í∞ïÎÇ®ÏßÄÏ†ê</option>
                    <option>ÎåÄÍµ¨ÏßÄÏ†ê</option>
                </select>
                <select class="form-select" id="storeSelect" style="width: 200px; height: 40px; font-size: 0.9rem;">
                    <option selected>Ïä§ÌÜ†Ïñ¥ ÏÑ†ÌÉù</option>
                    <option>Ïä§ÌÜ†Ïñ¥ A</option>
                    <option>Ïä§ÌÜ†Ïñ¥ B</option>
                </select>
            </div>
            <!-- Îã§Ïö¥Î°úÎìú Î≤ÑÌäº -->
            <div class="col d-flex justify-content-center">
                <button class="btn btn-success download-btn" style="width: 170px; height: 40px; font-size: 0.9rem;">
                    Excel Download
                </button>
            </div>
        </div>

        <!-- üìä ÌÖåÏù¥Î∏î & Ï∞®Ìä∏ -->
        <div class="chart-section">

            <!-- ÌÖåÏù¥Î∏î -->
            <div class="row mt-4">
                <div class="col-12">
                    <table class="table table-bordered text-company mb-0 text-center">
                        <thead class="table-light">
                        <tr>
                            <th id="days" style="width: 12%">ÎÇ†Ïßú</th>
                            <th style="width: 12%">ÏòàÏïΩÏûê</th>
                            <th style="width: 12%">Í∞ùÏã§</th>
                            <th style="width: 12%">Ï≤¥ÌÅ¨Ïù∏</th>
                            <th style="width: 12%">Ï≤¥ÌÅ¨ÏïÑÏõÉ</th>
                            <th style="width: 10%">Îß§Ï∂ú Í∏àÏï°</th>
                            <th style="width: 9%">ÏàòÏàòÎ£å</th>
                            <th style="width: 9%">Í≥µÏ†ú Í∏àÏï°</th>
                            <th style="width: 10%; color: green;" >ÏµúÏ¢Ö Ï†ïÏÇ∞ Í∏àÏï°</th>
                        </tr>
                        </thead>
                        <tbody class="text-center">
                        <tr th:each="roomList, stat : ${roomDTOList.content}">
                            <td><input type="text" class="form-control" th:value="${#temporals.format(roomList.createDate, 'yy-MM-dd HH:mm')}" readonly></td>
                            <td><input type="text" class="form-control" th:value="${roomList.memberDTO.memberName}" readonly></td>
                            <td><input type="text" class="form-control" th:value="${roomList.hotelRoomDTO.hotelRoomName}" readonly></td>

                            <!-- ÎÇ†Ïßú Îç∞Ïù¥ÌÑ∞Ïö© input -->
                            <td><input type="text" class="form-control checkin" th:value="${#temporals.format(roomList.checkInDate, 'yy-MM-dd HH:mm')}" readonly></td>
                            <td><input type="text" class="form-control checkout" th:value="${#temporals.format(roomList.checkOutDate, 'yy-MM-dd HH:mm')}" readonly></td>

                            <!-- Í∞ÄÍ≤© Îç∞Ïù¥ÌÑ∞ -->
                            <td>
                                <input hidden type="text" class="checkDays">
                                <input hidden type="text" class="price" th:value="${roomList.hotelRoomDTO.hotelRoomPrice}" readonly>
                                <input type="text" class="form-control priceResult" readonly>
                            </td>

                            <!-- Í≥ÑÏÇ∞ Í≤∞Í≥ºÏö© input -->
                            <td><input type="text" class="form-control commission" readonly></td>
                            <td><input type="text" class="form-control deduct" readonly></td>
                            <td><input type="text" class="form-control final" readonly></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- üìä Ï∞®Ìä∏Îì§ -->
            <div class="row mt-5">
                <div class="col-lg-8 mb-4">
                    <h5 class="mb-3">Îß§Ï∂ú & Ï†ïÏÇ∞ Ï∂îÏù¥</h5>
                    <canvas id="mixedChart" height="260"></canvas>
                </div>
                <div class="col-lg-4">
                    <h5 class="mb-3">Ï†ïÏÇ∞ ÎπÑÏú® Î∂ÑÏÑù</h5>
                    <canvas id="donutChart" height="260"></canvas>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('tbody tr').forEach(row => {
                // Í∞ÄÍ≤© Í∞ÄÏ†∏Ïò§Í∏∞
                const priceInput = row.querySelector('.price');
                if (!priceInput) {
                    console.error('Í∞ÄÍ≤© ÏûÖÎ†•ÎûÄÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                    return;
                }
                const price = parseFloat(priceInput.value);

                // ÎÇ†Ïßú Í∞ÄÏ†∏Ïò§Í∏∞
                const checkIn = new Date(row.querySelector('.checkin').value);
                const checkOut = new Date(row.querySelector('.checkout').value);

                // ÏàôÎ∞ï ÏùºÏàò Í≥ÑÏÇ∞ - ÏàòÏ†ïÎêú Î∂ÄÎ∂Ñ
                // Ï≤¥ÌÅ¨Ïù∏Í≥º Ï≤¥ÌÅ¨ÏïÑÏõÉÏù¥ Í∞ôÏùÄ ÎÇ†ÏßúÏó¨ÎèÑ 1ÏùºÎ°ú Í≥ÑÏÇ∞
                // Ï≤¥ÌÅ¨Ïù∏Í≥º Ï≤¥ÌÅ¨ÏïÑÏõÉÏù¥ Îã§Î•¥Î©¥ Ï∞®Ïù¥ + 1ÏùºÎ°ú Í≥ÑÏÇ∞
                let days;

                if (checkIn.toDateString() === checkOut.toDateString()) {
                    // Í∞ôÏùÄ ÎÇ†Ïù¥Î©¥ 1Ïùº ÏàôÎ∞ï
                    days = 1;
                } else {
                    // Îã§Î•∏ ÎÇ†Ïù¥Î©¥ Ï∞®Ïù¥ Í≥ÑÏÇ∞Ìï¥ÏÑú +1
                    const diffTime = Math.abs(checkOut - checkIn);
                    days = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
                }


                // Ï≤¥ÌÅ¨Ïù∏~Ï≤¥ÌÅ¨ÏïÑÏõÉ ÏùºÏàòÎ•º checkDaysÏóê Ï†ÄÏû• (classÎ°ú Î≥ÄÍ≤ΩÎê®)
                const checkDaysInput = row.querySelector('.checkDays');
                if (checkDaysInput) {
                    checkDaysInput.value = days;
                }

                // Îß§Ï∂ú Í∏àÏï° Í≥ÑÏÇ∞ (price x ÏùºÏàò)
                const sales = price * days;

                // Îß§Ï∂ú Í∏àÏï° ÌëúÏãú
                const priceResultInput = row.querySelector('.priceResult');
                if (priceResultInput) {
                    priceResultInput.value = Math.round(sales).toLocaleString() + 'Ïõê';
                }

                // ÏàòÏàòÎ£å (5%)
                const fee = sales * 0.05;
                const commissionInput = row.querySelector('.commission');
                if (commissionInput) {
                    commissionInput.value = Math.round(fee).toLocaleString() + 'Ïõê';
                }

                // Í≥µÏ†ú Í∏àÏï° (5%)
                const deduction = sales * 0.05;
                const deductInput = row.querySelector('.deduct');
                if (deductInput) {
                    deductInput.value = Math.round(deduction).toLocaleString() + 'Ïõê';
                }

                // ÏµúÏ¢Ö Ï†ïÏÇ∞ Í∏àÏï° (Îß§Ï∂ú - ÏàòÏàòÎ£å - Í≥µÏ†ú)
                const final = sales - fee - deduction;
                const finalInput = row.querySelector('.final');
                if (finalInput) {
                    finalInput.value = Math.round(final).toLocaleString() + 'Ïõê';
                    finalInput.style.color = 'green';
                }
            });
        });






        document.addEventListener('DOMContentLoaded', () => {
            const rows = document.querySelectorAll('tbody tr');

            const labels = []; // ÎÇ†Ïßú
            const salesList = []; // Îß§Ï∂ú
            const finalList = []; // ÏµúÏ¢Ö Ï†ïÏÇ∞
            let totalSales = 0;
            let totalCommission = 0;
            let totalDeduct = 0;
            let totalFinal = 0;

            rows.forEach(row => {
                const date = row.querySelector('td input')?.value || '';
                const priceText = row.querySelector('.priceResult')?.value.replace(/[^\d]/g, '') || '0';
                const commissionText = row.querySelector('.commission')?.value.replace(/[^\d]/g, '') || '0';
                const deductText = row.querySelector('.deduct')?.value.replace(/[^\d]/g, '') || '0';
                const finalText = row.querySelector('.final')?.value.replace(/[^\d]/g, '') || '0';

                const price = parseInt(priceText);
                const commission = parseInt(commissionText);
                const deduct = parseInt(deductText);
                const final = parseInt(finalText);

                labels.push(date.split(' ')[0]);
                salesList.push(price);
                finalList.push(final);

                totalSales += price;
                totalCommission += commission;
                totalDeduct += deduct;
                totalFinal += final;
            });

            // ÌòºÌï©Ìòï Ï∞®Ìä∏
            const mixedCtx = document.getElementById('mixedChart').getContext('2d');
            new Chart(mixedCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            type: 'bar',
                            label: 'Îß§Ï∂ú Í∏àÏï°',
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            data: salesList,
                            borderRadius: 5
                        },
                        {
                            type: 'line',
                            label: 'ÏµúÏ¢Ö Ï†ïÏÇ∞ Í∏àÏï°',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 2,
                            fill: false,
                            data: finalList
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => value.toLocaleString() + 'Ïõê'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'end',
                            color: '#333',
                            formatter: value => value.toLocaleString() + 'Ïõê',
                            font: {
                                weight: 'bold'
                            }
                        }
                    }
                }
            });

            // ÎèÑÎÑõ Ï∞®Ìä∏
            const donutCtx = document.getElementById('donutChart').getContext('2d');
            new Chart(donutCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Ï†ïÏÇ∞Í∏àÏï°', 'ÏàòÏàòÎ£å', 'Í≥µÏ†úÍ∏àÏï°'],
                    datasets: [{
                        data: [totalFinal, totalCommission, totalDeduct],
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(255, 205, 86, 0.7)',
                            'rgba(255, 99, 132, 0.7)'
                        ],
                        borderColor: [
                            'rgba(75, 192, 192, 1)',
                            'rgba(255, 205, 86, 1)',
                            'rgba(255, 99, 132, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        datalabels: {
                            formatter: (value) => {
                                const sum = totalFinal + totalCommission + totalDeduct;
                                const percentage = ((value / sum) * 100).toFixed(1);
                                return `${percentage}%`;
                            },
                            color: '#fff',
                            font: {
                                weight: 'bold'
                            }
                        }
                    }
                }
            });
        });

    </script>

    <script>
        document.querySelector('.download-btn').addEventListener('click', () => {
            const table = document.querySelector('table');

            // ÌÖåÏù¥Î∏î Îç∞Ïù¥ÌÑ∞Î•º 2Ï∞®Ïõê Î∞∞Ïó¥Î°ú Î≥ÄÌôò
            const data = [];
            const headers = [];
            table.querySelectorAll('thead th').forEach(th => headers.push(th.innerText));
            data.push(headers);

            table.querySelectorAll('tbody tr').forEach(row => {
                const rowData = [];
                row.querySelectorAll('td').forEach(td => {
                    const input = td.querySelector('input');
                    rowData.push(input ? input.value : td.innerText);
                });
                data.push(rowData);
            });

            // SheetJSÎ•º Ïù¥Ïö©Ìïú Excel ÏÉùÏÑ±
            const worksheet = XLSX.utils.aoa_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Ï†ïÏÇ∞ Îç∞Ïù¥ÌÑ∞');

            // ÌååÏùº Îã§Ïö¥Î°úÎìú
            XLSX.writeFile(workbook, 'Ï†ïÏÇ∞_Îç∞Ïù¥ÌÑ∞.xlsx');
        });
    </script>


</div>
</body>
</html>
