<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout.html}">

<head>
    <meta charset="UTF-8">
    <title>ì¬ë¬´ ì •ì‚° ì°¨íŠ¸</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .chart-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }

        .form-select {
            max-width: 200px;
            margin-right: 15px;
        }

        .download-btn {
            float: right;
        }

        table {
            font-size: 0.9rem;
        }

        canvas {
            background-color: #fff;
            border-radius: 10px;
        }
    </style>
</head>

<body>
<div layout:fragment="content" class="container mt-5">

    <h2 class="mb-4 fw-bold text-primary">ì¬ë¬´ ì •ì‚° ì°¨íŠ¸</h2>

    <!-- ğŸ”½ ì„ íƒ í•„í„° -->
    <div class="d-flex flex-wrap align-items-center mb-4">
        <select class="form-select" id="hqSelect">
            <option selected>ë³¸ì‚¬ ì„ íƒ</option>
            <option>ì„œìš¸ë³¸ì‚¬</option>
            <option>ë¶€ì‚°ë³¸ì‚¬</option>
        </select>
        <select class="form-select" id="branchSelect">
            <option selected>ì§€ì‚¬ ì„ íƒ</option>
            <option>ì¤‘ë¶€ì§€ì‚¬</option>
            <option>ë‚¨ë¶€ì§€ì‚¬</option>
        </select>
        <select class="form-select" id="officeSelect">
            <option selected>ì§€ì  ì„ íƒ</option>
            <option>ê°•ë‚¨ì§€ì </option>
            <option>ëŒ€êµ¬ì§€ì </option>
        </select>
        <select class="form-select" id="storeSelect">
            <option selected>ìŠ¤í† ì–´ ì„ íƒ</option>
            <option>ìŠ¤í† ì–´ A</option>
            <option>ìŠ¤í† ì–´ B</option>
        </select>
        <button class="btn btn-success download-btn">ì—‘ì…€ë¡œ ë‹¤ìš´ë¡œë“œ</button>
    </div>

    <!-- ğŸ“Š í…Œì´ë¸” & ì°¨íŠ¸ -->
    <div class="chart-section">

        <!-- í…Œì´ë¸” -->
        <div class="table-responsive">
            <table class="table table-bordered text-center">
                <thead class="table-primary">
                <tr>
                    <th>ë‚ ì§œ</th>
                    <th>ì˜ˆì•½ì</th>
                    <th>ê°ì‹¤</th>
                    <th>ì²´í¬ì¸</th>
                    <th>ì²´í¬ì•„ì›ƒ</th>
                    <th>ë§¤ì¶œ ê¸ˆì•¡</th>
                    <th>ìˆ˜ìˆ˜ë£Œ</th>
                    <th>ê³µì œ ê¸ˆì•¡</th>
                    <th>ìµœì¢… ì •ì‚° ê¸ˆì•¡</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="roomList, stat : ${roomDTOList.content}">
                    <td><input type="text" class="form-control" th:value="${#temporals.format(roomList.createDate, 'yyyy-MM-dd HH:mm')}" readonly></td>
                    <td><input type="text" class="form-control" th:value="${roomList.memberDTO.memberName}" readonly></td>
                    <td><input type="text" class="form-control" th:value="${roomList.hotelRoomDTO.hotelRoomName}" readonly></td>

                    <!-- ë‚ ì§œ ë°ì´í„°ìš© input -->
                    <td><input type="text" class="form-control checkin" th:value="${roomList.checkInDate}" readonly></td>
                    <td><input type="text" class="form-control checkout" th:value="${roomList.checkOutDate}" readonly></td>
                    
                    <!-- ê°€ê²© ë°ì´í„° -->
                    <td>
                        <input hidden type="text" class="checkDays">
                        <input hidden type="text" class="price" th:value="${roomList.hotelRoomDTO.hotelRoomPrice}" readonly>
                        <input type="text" class="form-control priceResult" readonly>
                    </td>

                    <!-- ê³„ì‚° ê²°ê³¼ìš© input -->
                    <td><input type="text" class="form-control commission" readonly></td>
                    <td><input type="text" class="form-control deduct" readonly></td>
                    <td><input type="text" class="form-control final" readonly></td>
                </tr>

                </tbody>
            </table>
        </div>



        <!-- ğŸ“Š ì°¨íŠ¸ë“¤ -->
        <div class="row mt-5">
            <div class="col-lg-8 mb-4">
                <h5 class="mb-3">ë§¤ì¶œ & ì •ì‚° ì¶”ì´</h5>
                <canvas id="mixedChart" height="260"></canvas>
            </div>
            <div class="col-lg-4">
                <h5 class="mb-3">ì •ì‚° ë¹„ìœ¨ ë¶„ì„</h5>
                <canvas id="donutChart" height="260"></canvas>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('tbody tr').forEach(row => {
                // ê°€ê²© ê°€ì ¸ì˜¤ê¸°
                const priceInput = row.querySelector('.price');
                if (!priceInput) {
                    console.error('ê°€ê²© ì…ë ¥ë€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                const price = parseFloat(priceInput.value);

                // ë‚ ì§œ ê°€ì ¸ì˜¤ê¸°
                const checkIn = new Date(row.querySelector('.checkin').value);
                const checkOut = new Date(row.querySelector('.checkout').value);

                // ìˆ™ë°• ì¼ìˆ˜ ê³„ì‚° - ìˆ˜ì •ëœ ë¶€ë¶„
                // ì²´í¬ì¸ê³¼ ì²´í¬ì•„ì›ƒì´ ê°™ì€ ë‚ ì§œì—¬ë„ 1ì¼ë¡œ ê³„ì‚°
                // ì²´í¬ì¸ê³¼ ì²´í¬ì•„ì›ƒì´ ë‹¤ë¥´ë©´ ì°¨ì´ + 1ì¼ë¡œ ê³„ì‚°
                let days;

                if (checkIn.toDateString() === checkOut.toDateString()) {
                    // ê°™ì€ ë‚ ì´ë©´ 1ì¼ ìˆ™ë°•
                    days = 1;
                } else {
                    // ë‹¤ë¥¸ ë‚ ì´ë©´ ì°¨ì´ ê³„ì‚°í•´ì„œ +1
                    const diffTime = Math.abs(checkOut - checkIn);
                    days = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
                }


                // ì²´í¬ì¸~ì²´í¬ì•„ì›ƒ ì¼ìˆ˜ë¥¼ checkDaysì— ì €ì¥ (classë¡œ ë³€ê²½ë¨)
                const checkDaysInput = row.querySelector('.checkDays');
                if (checkDaysInput) {
                    checkDaysInput.value = days;
                }

                // ë§¤ì¶œ ê¸ˆì•¡ ê³„ì‚° (price x ì¼ìˆ˜)
                const sales = price * days;

                // ë§¤ì¶œ ê¸ˆì•¡ í‘œì‹œ
                const priceResultInput = row.querySelector('.priceResult');
                if (priceResultInput) {
                    priceResultInput.value = Math.round(sales).toLocaleString() + 'ì›';
                }

                // ìˆ˜ìˆ˜ë£Œ (5%)
                const fee = sales * 0.05;
                const commissionInput = row.querySelector('.commission');
                if (commissionInput) {
                    commissionInput.value = Math.round(fee).toLocaleString() + 'ì›';
                }

                // ê³µì œ ê¸ˆì•¡ (5%)
                const deduction = sales * 0.05;
                const deductInput = row.querySelector('.deduct');
                if (deductInput) {
                    deductInput.value = Math.round(deduction).toLocaleString() + 'ì›';
                }

                // ìµœì¢… ì •ì‚° ê¸ˆì•¡ (ë§¤ì¶œ - ìˆ˜ìˆ˜ë£Œ - ê³µì œ)
                const final = sales - fee - deduction;
                const finalInput = row.querySelector('.final');
                if (finalInput) {
                    finalInput.value = Math.round(final).toLocaleString() + 'ì›';
                }
            });
        });






        document.addEventListener('DOMContentLoaded', () => {
            const rows = document.querySelectorAll('tbody tr');

            // ë°ì´í„° ë°°ì—´ ì´ˆê¸°í™”
            const labels = []; // ë‚ ì§œ
            const salesList = []; // ë§¤ì¶œ
            const finalList = []; // ìµœì¢… ì •ì‚°
            let totalSales = 0;
            let totalCommission = 0;
            let totalDeduct = 0;
            let totalFinal = 0;

            rows.forEach(row => {
                const date = row.querySelector('td input')?.value || ''; // ì²« ë²ˆì§¸ tdì˜ input
                const priceText = row.querySelector('.priceResult')?.value.replace(/[^\d]/g, '') || '0';
                const commissionText = row.querySelector('.commission')?.value.replace(/[^\d]/g, '') || '0';
                const deductText = row.querySelector('.deduct')?.value.replace(/[^\d]/g, '') || '0';
                const finalText = row.querySelector('.final')?.value.replace(/[^\d]/g, '') || '0';

                const price = parseInt(priceText);
                const commission = parseInt(commissionText);
                const deduct = parseInt(deductText);
                const final = parseInt(finalText);

                // ë‚ ì§œì™€ ê¸ˆì•¡ ì €ì¥
                labels.push(date.split(' ')[0]); // ë‚ ì§œë§Œ ì¶”ì¶œ
                salesList.push(price);
                finalList.push(final);

                totalSales += price;
                totalCommission += commission;
                totalDeduct += deduct;
                totalFinal += final;
            });

            // âœ… í˜¼í•©í˜• ì°¨íŠ¸ (ë§¤ì¶œ & ì •ì‚°)
            const mixedCtx = document.getElementById('mixedChart').getContext('2d');
            new Chart(mixedCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            type: 'bar',
                            label: 'ë§¤ì¶œ ê¸ˆì•¡',
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            data: salesList,
                            borderRadius: 5
                        },
                        {
                            type: 'line',
                            label: 'ìµœì¢… ì •ì‚° ê¸ˆì•¡',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 2,
                            fill: false,
                            data: finalList
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => value.toLocaleString() + 'ì›'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'end',
                            color: '#333',
                            formatter: value => value.toLocaleString() + 'ì›',
                            font: {
                                weight: 'bold'
                            }
                        }
                    }

                }
            });

// âœ… ë„ë„› ì°¨íŠ¸ (ì „ì²´ ë¹„ìœ¨)
            const donutCtx = document.getElementById('donutChart').getContext('2d');
            new Chart(donutCtx, {
                type: 'doughnut',
                data: {
                    labels: ['ì •ì‚°ê¸ˆì•¡', 'ìˆ˜ìˆ˜ë£Œ', 'ê³µì œê¸ˆì•¡'],
                    datasets: [{
                        data: [totalFinal, totalCommission, totalDeduct],
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(255, 205, 86, 0.7)',
                            'rgba(255, 99, 132, 0.7)'
                        ],
                        borderColor: [
                            'rgba(75, 192, 192, 1)',
                            'rgba(255, 205, 86, 1)',
                            'rgba(255, 99, 132, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        datalabels: {
                            formatter: (value, context) => {
                                const sum = totalFinal + totalCommission + totalDeduct;
                                const percentage = ((value / sum) * 100).toFixed(1);
                                return `${percentage}%`;
                            },
                            color: '#fff',
                            font: {
                                weight: 'bold'
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });

        });
    </script>


</div>
</body>
</html>
