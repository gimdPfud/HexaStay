<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout.html}">

<head>
    <meta charset="UTF-8">
    <title>Ïû¨Î¨¥ Ï†ïÏÇ∞ Ï∞®Ìä∏ (ÏóÖÏ≤¥)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .chart-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }

        .form-select {
            max-width: 200px;
            margin-right: 15px;
        }

        .download-btn {
            float: right;
        }

        table {
            font-size: 0.9rem;
        }

        canvas {
            background-color: #fff;
            border-radius: 10px;
        }
        
        .date-range-container {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .date-input {
            width: 180px;
            margin-right: 8px;
        }
        
        .date-button {
            margin-left: 8px;
        }
    </style>
</head>

<body>
<div layout:fragment="content" class="container mt-5">

    <h2 class="mb-4 fw-bold text-primary">Ïû¨Î¨¥ Ï†ïÏÇ∞ Ï∞®Ìä∏</h2>

    <!-- üîΩ ÏÑ†ÌÉù ÌïÑÌÑ∞ -->
    <div class="d-flex flex-wrap align-items-center mb-4">
        <select class="form-select" id="hqSelect">
            <option selected>Î≥∏ÏÇ¨ ÏÑ†ÌÉù</option>
            <option>ÏÑúÏö∏Î≥∏ÏÇ¨</option>
            <option>Î∂ÄÏÇ∞Î≥∏ÏÇ¨</option>
        </select>
        <select class="form-select" id="branchSelect">
            <option selected>ÏßÄÏÇ¨ ÏÑ†ÌÉù</option>
            <option>Ï§ëÎ∂ÄÏßÄÏÇ¨</option>
            <option>ÎÇ®Î∂ÄÏßÄÏÇ¨</option>
        </select>
        <select class="form-select" id="officeSelect">
            <option selected>ÏßÄÏ†ê ÏÑ†ÌÉù</option>
            <option>Í∞ïÎÇ®ÏßÄÏ†ê</option>
            <option>ÎåÄÍµ¨ÏßÄÏ†ê</option>
        </select>
        <select class="form-select" id="storeSelect">
            <option selected>Ïä§ÌÜ†Ïñ¥ ÏÑ†ÌÉù</option>
            <option>Ïä§ÌÜ†Ïñ¥ A</option>
            <option>Ïä§ÌÜ†Ïñ¥ B</option>
        </select>
        <button class="btn btn-success download-btn">ÏóëÏÖÄÎ°ú Îã§Ïö¥Î°úÎìú</button>
    </div>
    
    <!-- ÎÇ†Ïßú ÏÑ†ÌÉù ÌïÑÌÑ∞ Ï∂îÍ∞Ä -->
    <div class="date-range-container">
        <input type="date" id="startDate" name="startDate" class="form-control date-input">
        <span>~</span>
        <input type="date" id="endDate" name="endDate" class="form-control date-input">
        <button id="dateSearchBtn" class="btn btn-primary date-button">ÎÇ†ÏßúÎ°ú Ï°∞Ìöå</button>
        <button id="resetDateBtn" class="btn btn-secondary date-button">Ï†ÑÏ≤¥ Ï°∞Ìöå</button>
    </div>

    <!-- üìä ÌÖåÏù¥Î∏î & Ï∞®Ìä∏ -->
    <div class="chart-section">

        <!-- ÌÖåÏù¥Î∏î -->
        <div class="table-responsive">
            <table class="table table-bordered text-center">
                <thead class="table-primary">
                <tr>
                    <th>ÎÇ†Ïßú</th>
                    <th>ÏòàÏïΩÏûê</th>
                    <th>Í∞ùÏã§</th>
                    <th>Ï≤¥ÌÅ¨Ïù∏</th>
                    <th>Ï≤¥ÌÅ¨ÏïÑÏõÉ</th>
                    <th>Îß§Ï∂ú Í∏àÏï°</th>
                    <th>ÏàòÏàòÎ£å</th>
                    <th>Í≥µÏ†ú Í∏àÏï°</th>
                    <th>ÏµúÏ¢Ö Ï†ïÏÇ∞ Í∏àÏï°</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="storeList : ${storeDTOList.content}">
                    <td><input type="text" class="form-control" th:value="${#temporals.format(storeList.createDate, 'yyyy-MM-dd HH:mm')}" readonly></td>
                    <td><input type="text" class="form-control" th:value="${storeList.orderstoreMessage}" readonly></td>
                    <td><input type="text" class="form-control" th:value="${storeList.orderstoreMessage}" readonly></td>

                    <!-- ÎÇ†Ïßú Îç∞Ïù¥ÌÑ∞Ïö© input -->
                    <td><input type="text" class="form-control checkin" th:value="${storeList.orderstoreMessage}" readonly></td>
                    <td><input type="text" class="form-control checkout" th:value="${storeList.orderstoreMessage}" readonly></td>
                    
                    <!-- Í∞ÄÍ≤© Îç∞Ïù¥ÌÑ∞ -->
                    <td>
                        <input hidden type="text" class="checkDays">
                        <input hidden type="text" class="price" th:value="${storeList.orderstoreMessage}" readonly>
                        <input type="text" class="form-control priceResult" readonly>
                    </td>

                    <!-- Í≥ÑÏÇ∞ Í≤∞Í≥ºÏö© input -->
                    <td><input type="text" class="form-control commission" readonly></td>
                    <td><input type="text" class="form-control deduct" readonly></td>
                    <td><input type="text" class="form-control final" readonly></td>
                </tr>

                </tbody>
            </table>
        </div>



        <!-- üìä Ï∞®Ìä∏Îì§ -->
        <div class="row mt-5">
            <div class="col-lg-8 mb-4">
                <h5 class="mb-3">Îß§Ï∂ú & Ï†ïÏÇ∞ Ï∂îÏù¥</h5>
                <canvas id="mixedChart" height="260"></canvas>
            </div>
            <div class="col-lg-4">
                <h5 class="mb-3">Ï†ïÏÇ∞ ÎπÑÏú® Î∂ÑÏÑù</h5>
                <canvas id="donutChart" height="260"></canvas>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ÎÇ†Ïßú ÌïÑÎìú Ï¥àÍ∏∞Ìôî (ÌòÑÏû¨ ÏõîÏùò Ï≤´ÎÇ†Í≥º Ïò§Îäò ÎÇ†Ïßú)
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            
            // YYYY-MM-DD ÌòïÏãùÏúºÎ°ú Î≥ÄÌôò
            const formatDate = function(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            
            document.getElementById('startDate').value = formatDate(firstDayOfMonth);
            document.getElementById('endDate').value = formatDate(today);
            
            // ÎÇ†ÏßúÎ°ú Ï°∞Ìöå Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
            document.getElementById('dateSearchBtn').addEventListener('click', function(e) {
                e.preventDefault();
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                // ÌòÑÏû¨ URLÏóêÏÑú pathname Î∂ÄÎ∂ÑÎßå Í∞ÄÏ†∏Ïò¥
                const pathName = window.location.pathname;
                
                // ÏÉà URL ÏÉùÏÑ± (ÏøºÎ¶¨ ÌååÎùºÎØ∏ÌÑ∞ Ï∂îÍ∞Ä)
                window.location.href = `${pathName}?startDate=${startDate}&endDate=${endDate}`;
            });
            
            // Ï†ÑÏ≤¥ Ï°∞Ìöå Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
            document.getElementById('resetDateBtn').addEventListener('click', function(e) {
                e.preventDefault();
                // ÌòÑÏû¨ URLÏóêÏÑú pathname Î∂ÄÎ∂ÑÎßå Í∞ÄÏ†∏ÏôÄÏÑú ÏøºÎ¶¨ ÌååÎùºÎØ∏ÌÑ∞ ÏóÜÏù¥ Ïù¥Îèô
                const pathName = window.location.pathname;
                window.location.href = pathName;
            });
            
            // URLÏóêÏÑú ÏøºÎ¶¨ ÌååÎùºÎØ∏ÌÑ∞Î•º ÌÜµÌï¥ ÎÇ†Ïßú ÌïÑÌÑ∞ Ï†ÅÏö©
            const urlParams = new URLSearchParams(window.location.search);
            const startDateParam = urlParams.get('startDate');
            const endDateParam = urlParams.get('endDate');
            
            if(startDateParam && endDateParam) {
                // URLÏóê ÎÇ†Ïßú ÌååÎùºÎØ∏ÌÑ∞Í∞Ä ÏûàÏúºÎ©¥ ÌïÑÌÑ∞ÎßÅ Î°úÏßÅ Ïã§Ìñâ
                document.getElementById('startDate').value = startDateParam;
                document.getElementById('endDate').value = endDateParam;
                
                // ÎÇ†Ïßú Î≤îÏúÑÏóê ÏÜçÌïòÏßÄ ÏïäÎäî Ìñâ Ïà®Í∏∞Í∏∞
                filterTableByDateRange(startDateParam, endDateParam);
            }
            
            // Í∞ÄÍ≤© Í≥ÑÏÇ∞ Î°úÏßÅ Ïã§Ìñâ
            calculatePrices();
            
            // Ï∞®Ìä∏ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏ Î∞è Î†åÎçîÎßÅ
            initAndUpdateCharts();
            
            // ÌÖåÏù¥Î∏î ÎÇ†Ïßú ÌïÑÌÑ∞ÎßÅ Ìï®Ïàò
            function filterTableByDateRange(start, end) {
                const startDate = new Date(start);
                const endDate = new Date(end);
                endDate.setHours(23, 59, 59); // Ï¢ÖÎ£åÏùº ÎßàÏßÄÎßâ ÏãúÍ∞ÑÏúºÎ°ú ÏÑ§Ï†ï
                
                const tableRows = document.querySelectorAll('tbody tr');
                tableRows.forEach(row => {
                    const dateCell = row.querySelector('td:first-child input');
                    if(dateCell) {
                        const rowDate = new Date(dateCell.value);
                        if(rowDate < startDate || rowDate > endDate) {
                            row.style.display = 'none';
                        } else {
                            row.style.display = '';
                        }
                    }
                });
                
                // ÌïÑÌÑ∞ÎßÅ ÌõÑ Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
                initAndUpdateCharts();
            }
            
            // Í∞ÄÍ≤© Í≥ÑÏÇ∞ Î°úÏßÅ
            function calculatePrices() {
                document.querySelectorAll('tbody tr').forEach(row => {
                    // Í∞ÄÍ≤© Í∞ÄÏ†∏Ïò§Í∏∞
                    const priceInput = row.querySelector('.price');
                    if (!priceInput) {
                        console.error('Í∞ÄÍ≤© ÏûÖÎ†•ÎûÄÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                        return;
                    }
                    const price = parseFloat(priceInput.value);

                    // ÎÇ†Ïßú Í∞ÄÏ†∏Ïò§Í∏∞
                    const checkIn = new Date(row.querySelector('.checkin').value);
                    const checkOut = new Date(row.querySelector('.checkout').value);

                    // ÏàôÎ∞ï ÏùºÏàò Í≥ÑÏÇ∞ 
                    let days;
                    if (checkIn.toDateString() === checkOut.toDateString()) {
                        // Í∞ôÏùÄ ÎÇ†Ïù¥Î©¥ 1Ïùº ÏàôÎ∞ï
                        days = 1;
                    } else {
                        // Îã§Î•∏ ÎÇ†Ïù¥Î©¥ Ï∞®Ïù¥ Í≥ÑÏÇ∞Ìï¥ÏÑú +1
                        const diffTime = Math.abs(checkOut - checkIn);
                        days = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    }

                    // Ï≤¥ÌÅ¨Ïù∏~Ï≤¥ÌÅ¨ÏïÑÏõÉ ÏùºÏàòÎ•º checkDaysÏóê Ï†ÄÏû•
                    const checkDaysInput = row.querySelector('.checkDays');
                    if (checkDaysInput) {
                        checkDaysInput.value = days;
                    }

                    // Îß§Ï∂ú Í∏àÏï° Í≥ÑÏÇ∞ (price x ÏùºÏàò)
                    const sales = price * days;

                    // Îß§Ï∂ú Í∏àÏï° ÌëúÏãú
                    const priceResultInput = row.querySelector('.priceResult');
                    if (priceResultInput) {
                        priceResultInput.value = Math.round(sales).toLocaleString() + 'Ïõê';
                    }

                    // ÏàòÏàòÎ£å (5%)
                    const fee = sales * 0.05;
                    const commissionInput = row.querySelector('.commission');
                    if (commissionInput) {
                        commissionInput.value = Math.round(fee).toLocaleString() + 'Ïõê';
                    }

                    // Í≥µÏ†ú Í∏àÏï° (5%)
                    const deduction = sales * 0.05;
                    const deductInput = row.querySelector('.deduct');
                    if (deductInput) {
                        deductInput.value = Math.round(deduction).toLocaleString() + 'Ïõê';
                    }

                    // ÏµúÏ¢Ö Ï†ïÏÇ∞ Í∏àÏï° (Îß§Ï∂ú - ÏàòÏàòÎ£å - Í≥µÏ†ú)
                    const final = sales - fee - deduction;
                    const finalInput = row.querySelector('.final');
                    if (finalInput) {
                        finalInput.value = Math.round(final).toLocaleString() + 'Ïõê';
                    }
                });
            }
            
            // Ï∞®Ìä∏ Ï¥àÍ∏∞Ìôî Î∞è ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
            function initAndUpdateCharts() {
                // Î≥¥Ïù¥Îäî Ìñâ(displayÍ∞Ä noneÏù¥ ÏïÑÎãå Ìñâ)Îßå ÏÑ†ÌÉù
                const visibleRows = Array.from(document.querySelectorAll('tbody tr')).filter(row => 
                    row.style.display !== 'none'
                );

                // Îç∞Ïù¥ÌÑ∞ Î∞∞Ïó¥ Ï¥àÍ∏∞Ìôî
                const labels = []; // ÎÇ†Ïßú
                const salesList = []; // Îß§Ï∂ú
                const finalList = []; // ÏµúÏ¢Ö Ï†ïÏÇ∞
                let totalSales = 0;
                let totalCommission = 0;
                let totalDeduct = 0;
                let totalFinal = 0;

                visibleRows.forEach(row => {
                    const date = row.querySelector('td input')?.value || ''; // Ï≤´ Î≤àÏß∏ tdÏùò input
                    const priceText = row.querySelector('.priceResult')?.value.replace(/[^\d]/g, '') || '0';
                    const commissionText = row.querySelector('.commission')?.value.replace(/[^\d]/g, '') || '0';
                    const deductText = row.querySelector('.deduct')?.value.replace(/[^\d]/g, '') || '0';
                    const finalText = row.querySelector('.final')?.value.replace(/[^\d]/g, '') || '0';

                    const price = parseInt(priceText);
                    const commission = parseInt(commissionText);
                    const deduct = parseInt(deductText);
                    const final = parseInt(finalText);

                    // ÎÇ†ÏßúÏôÄ Í∏àÏï° Ï†ÄÏû•
                    labels.push(date.split(' ')[0]); // ÎÇ†ÏßúÎßå Ï∂îÏ∂ú
                    salesList.push(price);
                    finalList.push(final);

                    totalSales += price;
                    totalCommission += commission;
                    totalDeduct += deduct;
                    totalFinal += final;
                });
                
                // ÌòºÌï©Ìòï Ï∞®Ìä∏ (Îß§Ï∂ú & Ï†ïÏÇ∞)
                const mixedCtx = document.getElementById('mixedChart').getContext('2d');
                
                // Í∏∞Ï°¥ Ï∞®Ìä∏Í∞Ä ÏûàÏúºÎ©¥ Ï†úÍ±∞
                if (window.mixedChart instanceof Chart) {
                    window.mixedChart.destroy();
                }
                
                // ÏÉà Ï∞®Ìä∏ ÏÉùÏÑ±
                window.mixedChart = new Chart(mixedCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                type: 'bar',
                                label: 'Îß§Ï∂ú Í∏àÏï°',
                                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                data: salesList,
                                borderRadius: 5
                            },
                            {
                                type: 'line',
                                label: 'ÏµúÏ¢Ö Ï†ïÏÇ∞ Í∏àÏï°',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 2,
                                fill: false,
                                data: finalList
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value.toLocaleString() + 'Ïõê';
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        label += context.parsed.y.toLocaleString() + 'Ïõê';
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });

                // ÎèÑÎÑõ Ï∞®Ìä∏ (Ï†ïÏÇ∞ ÎπÑÏú®)
                const donutCtx = document.getElementById('donutChart').getContext('2d');
                
                // Í∏∞Ï°¥ Ï∞®Ìä∏Í∞Ä ÏûàÏúºÎ©¥ Ï†úÍ±∞
                if (window.donutChart instanceof Chart) {
                    window.donutChart.destroy();
                }
                
                // ÏÉà Ï∞®Ìä∏ ÏÉùÏÑ±
                window.donutChart = new Chart(donutCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Ï†ïÏÇ∞Í∏àÏï°', 'ÏàòÏàòÎ£å', 'Í≥µÏ†úÍ∏àÏï°'],
                        datasets: [{
                            data: [totalFinal, totalCommission, totalDeduct],
                            backgroundColor: [
                                'rgba(75, 192, 192, 0.7)',
                                'rgba(255, 205, 86, 0.7)',
                                'rgba(255, 99, 132, 0.7)'
                            ],
                            borderColor: [
                                'rgba(75, 192, 192, 1)',
                                'rgba(255, 205, 86, 1)',
                                'rgba(255, 99, 132, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const sum = totalFinal + totalCommission + totalDeduct;
                                        const percentage = ((context.parsed / sum) * 100).toFixed(1);
                                        return `${context.label}: ${context.parsed.toLocaleString()}Ïõê (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        });
    </script>


</div>
</body>
</html>
