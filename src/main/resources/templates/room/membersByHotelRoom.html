<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>room ë°°ì • íšŒì› ëª©ë¡</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<body>

<div class="container mt-5">

    <p>ë£¸ ë²ˆí˜¸: [[${roomNum}]]</p>

    <p>ë£¸ë²ˆí˜¸ í™•ì¸: [[${roomNum} != null ? ${roomNum} : 'ë„˜ì–´ì˜¤ì§€ ì•ŠìŒ']]</p>

    <h3 class="fw-bold mb-4 text-center">room ë°°ì • íšŒì› ëª©ë¡</h3>

    <table class="table table-bordered text-company mb-0">
        <thead class="table-light text-center">
        <tr>
            <th style="width: 20%;">íšŒì› ë²ˆí˜¸</th>
            <th style="width: 20%;">ì´ë¦„</th>
            <th style="width: 20%;">ì „í™”ë²ˆí˜¸</th>
            <th style="width: 20%;">ì´ë©”ì¼</th>
            <th style="width: 20%;"></th>
        </tr>
        </thead>

        <tbody>
        <tr th:each="member : ${members}" th:data-member-num="${member.memberNum}" class="text-center">
            <td class="member-num" th:text="${member.memberNum}"></td>
            <td class="member-name" th:text="${member.memberName}"></td>
            <td class="member-phone" th:text="${member.memberPhone}"></td>
            <td class="member-email" th:text="${member.memberEmail}"></td>
            <td>
                <button class="btn btn-primary btn-sm btn-icon"
                        data-bs-toggle="modal"
                        data-bs-target="#editMemberModal"
                        th:attr="data-member-num=${member.memberNum},
                                 data-member-name=${member.memberName},
                                 data-member-phone=${member.memberPhone},
                                 data-member-email=${member.memberEmail}">
                    ìˆ˜ì •
                </button>
                <button onclick="openMemberModalWithRoomNum(101)">íšŒì› ìˆ˜ì •</button>
            </td>
        </tr>
        </tbody>
    </table>
    <!-- âœ… í…ŒìŠ¤íŠ¸ìš©ìœ¼ë¡œ ê°•ì œë¡œ roomNum ì „ë‹¬ -->
    <button type="button" class="btn btn-outline-secondary"
            onclick="openMemberModalWithRoomNum(123)">íšŒì› ìˆ˜ì •</button>

    <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
    <nav aria-label="íšŒì› í˜ì´ì§€ë„¤ì´ì…˜">
        <ul class="pagination justify-content-center mt-5">
            <li class="page-item" th:classappend="${members.first} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/membersByHotelRoom/{hotelRoomNum}(hotelRoomNum=${hotelRoomNum}, page=${currentPage - 1})}"
                   th:if="${!members.first}">ì´ì „</a>
                <span class="page-link" th:if="${members.first}">ì´ì „</span>
            </li>

            <li th:each="i : ${#numbers.sequence(0, members.totalPages - 1)}"
                class="page-item active" th:classappend="${currentPage == i} ? 'active'">
                <a class="page-link"
                   th:href="@{/membersByHotelRoom/{hotelRoomNum}(hotelRoomNum=${hotelRoomNum}, page=${i})}"
                   th:text="${i + 1}"></a>
            </li>

            <li class="page-item" th:classappend="${members.last} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/membersByHotelRoom/{hotelRoomNum}(hotelRoomNum=${hotelRoomNum}, page=${currentPage + 1})}"
                   th:if="${!members.last}">ë‹¤ìŒ</a>
                <span class="page-link" th:if="${members.last}">ë‹¤ìŒ</span>
            </li>
        </ul>
    </nav>
</div>

<!-- íšŒì› ê²€ìƒ‰í›„ ìˆ˜ì • ëª¨ë‹¬ -->
<div class="modal fade" id="memberModal" tabindex="-1" aria-labelledby="memberModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="memberModalLabel">íšŒì› ê²€ìƒ‰</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- âœ… ìˆ¨ê²¨ì§„ ë£¸ ë„˜ë²„ input -->
                <input type="hidden" id="roomNumHidden">
                <div class="mb-3">
                    <input type="text" id="memberSearchInput" class="form-control" placeholder="ì´ë¦„ ë˜ëŠ” ì´ë©”ì¼ ê²€ìƒ‰..."/>
                    <button class="btn btn-outline-primary mt-2" type="button" onclick="searchMembers()">ê²€ìƒ‰</button>
                </div>
                <table class="table table-hover">
                    <thead>
                    <tr>
                        <th>ë²ˆí˜¸</th>
                        <th>ì´ë¦„</th>
                        <th>ì´ë©”ì¼</th>
                        <th>ì „í™”ë²ˆí˜¸</th>
                        <th>ì„ íƒ</th>
                    </tr>
                    </thead>
                    <tbody id="memberSearchResults"></tbody>
                </table>
                <button type="button" class="btn btn-outline-secondary" onclick="openMemberModalWithRoomNum(123)">íšŒì› ìˆ˜ì •</button>
            </div>
        </div>
    </div>
</div>



<!-- íšŒì› ìˆ˜ì • ëª¨ë‹¬ -->
<div class="modal fade" id="editMemberModal" tabindex="-1" aria-labelledby="editMemberModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <form method="post" id="editMemberForm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editMemberModalLabel">íšŒì› ì •ë³´ ìˆ˜ì •</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="memberNum" id="modalMemberNum">
                    <div class="mb-3">
                        <label for="modalMemberName" class="form-label">ì´ë¦„</label>
                        <input type="text" class="form-control" id="modalMemberName" name="memberName" required>
                    </div>
                    <div class="mb-3">
                        <label for="modalMemberPhone" class="form-label">ì „í™”ë²ˆí˜¸</label>
                        <input type="text" class="form-control" id="modalMemberPhone" name="memberPhone" required>
                    </div>
                    <div class="mb-3">
                        <label for="modalMemberEmail" class="form-label">ì´ë©”ì¼</label>
                        <input type="email" class="form-control" id="modalMemberEmail" name="memberEmail" required>
                    </div>
                </div>
                <div class="modal-footer d-flex justify-content-center">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ì €ì¥</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    function openMemberModalWithRoomNum(roomNum) {
        console.log("ì—´ë¦° ë£¸ ë„˜ë²„:", roomNum);
        document.getElementById('roomNumHidden').value = roomNum;
        const modal = new bootstrap.Modal(document.getElementById('memberModal'));
        modal.show();
    }

    function searchMembers() {
        const query = document.getElementById('memberSearchInput').value;
        if (!query.trim()) {
            alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        fetch(`/admin/member/search?keyword=${encodeURIComponent(query)}`)
            .then(res => {
                if (!res.ok) throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${res.status}`);
                return res.json();
            })
            .then(data => {
                const tbody = document.getElementById('memberSearchResults');
                tbody.innerHTML = "";
                if (data.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='5' class='text-center'>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
                    return;
                }

                const roomNum = document.getElementById('roomNumHidden').value;

                data.forEach(member => {
                    const row = `
                    <tr>
                        <td>${member.memberNum}</td>
                        <td>${member.memberName}</td>
                        <td>${member.memberEmail}</td>
                        <td>${member.memberPhone}</td>
                        <td>
                            <button type="button" class="btn btn-sm btn-primary select-member-btn"
                                data-room-num="${roomNum}"
                                data-member-num="${member.memberNum}"
                                data-member-name="${member.memberName}"
                                data-member-email="${member.memberEmail}"
                                data-member-phone="${member.memberPhone}">
                                ê²€ìƒ‰ìˆ˜ì •
                            </button>
                        </td>
                    </tr>`;
                    tbody.insertAdjacentHTML("beforeend", row);
                });
            })
            .catch(error => {
                console.error("íšŒì› ê²€ìƒ‰ ì˜¤ë¥˜:", error);
                alert("íšŒì› ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
    }

    document.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('select-member-btn')) {
            const btn = e.target;
            const memberNum = btn.getAttribute('data-member-num');
            const memberName = btn.getAttribute('data-member-name');
            const memberEmail = btn.getAttribute('data-member-email');
            const memberPhone = btn.getAttribute('data-member-phone');
            const roomNum = btn.getAttribute('data-room-num');

            selectMember(memberNum, memberName, memberEmail, memberPhone, roomNum);
        }
    });

    function selectMember(memberNum, memberName, memberEmail, memberPhone, roomNum) {
        if (!roomNum) {
            alert("roomNum ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        if (!confirm(`${memberName} íšŒì›ìœ¼ë¡œ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        fetch("/admin/room/update-member", {
            method: "POST",
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `roomNum=${roomNum}&newMemberNum=${memberNum}`
        })
            .then(res => {
                if (!res.ok) throw new Error("íšŒì› ìˆ˜ì • ì‹¤íŒ¨");
                return res.text();
            })
            .then(msg => {
                alert(msg);
                const modal = bootstrap.Modal.getInstance(document.getElementById('memberModal'));
                modal.hide();
                location.reload();
            })
            .catch(err => {
                console.error(err);
                alert("íšŒì› ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
    }





        /*ìˆ˜ë™ modal ìˆ˜ì • script ë©”ì†Œë“œ*/
        // ğŸŸ¢ DOMì´ ë¡œë“œëœ í›„ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', function () {
            const editMemberModal = document.getElementById('editMemberModal');
            editMemberModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                document.getElementById('modalMemberNum').value = button.getAttribute('data-member-num');
                document.getElementById('modalMemberName').value = button.getAttribute('data-member-name');
                document.getElementById('modalMemberPhone').value = button.getAttribute('data-member-phone');
                document.getElementById('modalMemberEmail').value = button.getAttribute('data-member-email');
            });

            const editMemberForm = document.getElementById('editMemberForm');
            editMemberForm.addEventListener('submit', function (event) {
                event.preventDefault();

                const formData = {
                    memberNum: document.getElementById('modalMemberNum').value,
                    memberName: document.getElementById('modalMemberName').value,
                    memberPhone: document.getElementById('modalMemberPhone').value,
                    memberEmail: document.getElementById('modalMemberEmail').value
                };

                fetch('/member/update/ajax', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(formData)
                })
                    .then(response => {
                        if (response.ok) {
                            alert("âœ… ìˆ˜ì • ì™„ë£Œ");
                            window.location.reload();
                        } else {
                            return response.text().then(text => {
                                throw new Error(text);
                            });
                        }
                    })
                    .catch(error => {
                        alert("âŒ ìˆ˜ì • ì‹¤íŒ¨: " + error.message);
                    });
            });
        });

</script>

</body>
</html>
