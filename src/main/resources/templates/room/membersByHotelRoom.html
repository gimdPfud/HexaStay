<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>room ë°°ì • íšŒì› ëª©ë¡</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<style>
    /*ë¶€íŠ¸ìŠ¤ë© card ë§ˆìš°ìŠ¤ ê°€ì ¸ë‹¤ ëì„ë•Œ í…Œë‘ë¦¬ íš¨ê³¼ Class=""*/
    .member-card {
        transition: all 0.3s ease;
        border: 1px solid #dee2e6; /* ê¸°ë³¸ í…Œë‘ë¦¬ */
    }

    .member-card:hover {
        border-color: #0d6efd; /* ë¶€íŠ¸ìŠ¤íŠ¸ë© primary ìƒ‰ìƒ */
        box-shadow: 0 0 10px rgba(13, 110, 253, 0.25);
    }

    /*form-control : íš¨ê³¼ style Class="" */
    .form-control:focus {
        border-color: #0d6efd; /* Bootstrap primary */
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        transition: all 0.3s ease-in-out;
    }

    .form-control:valid {
        border-color: #198754; /* Bootstrap success */
    }

    .form-control:invalid {
        border-color: #dc3545; /* Bootstrap danger */
    }
    /*form-control : íš¨ê³¼ style*/

</style>
<body>

<div class="container mt-5">

    <h3 class="fw-bold mb-4 text-center text-dark"
        th:text="${roomNum} + 'ë²ˆ: Roomì— ë°°ì •ëœ íšŒì› ëª©ë¡'">
    </h3>

    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        <div class="col" th:each="member : ${members}">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body member-card">
                    <h5 class="card-title fw-semibold text-primary">
                        <span th:text="${member.memberName}">ì´ë¦„</span>
                        <small class="text-muted">(#<span th:text="${member.memberNum}"></span>)</small>
                    </h5>
                    <p class="card-text mb-1">
                        <strong>ì „í™”ë²ˆí˜¸:</strong> <span th:text="${member.memberPhone}"></span>
                    </p>
                    <p class="card-text mb-3">
                        <strong>ì´ë©”ì¼:</strong> <span th:text="${member.memberEmail}"></span>
                    </p>

                    <div class="d-flex justify-content-between flex-wrap gap-2">
                        <button type="button"
                                class="btn btn-sm btn-outline-primary w-100"
                                data-bs-toggle="modal"
                                data-bs-target="#editMemberModal"
                                th:attr="data-member-num=${member.memberNum},
                                     data-member-name=${member.memberName},
                                     data-member-phone=${member.memberPhone},
                                     data-member-email=${member.memberEmail}">
                            íšŒì›ì •ë³´ ìˆ˜ì •
                        </button>

                        <button type="button"
                                class="btn btn-sm btn-outline-secondary w-100 open-member-modal-btn"
                                th:attr="data-room-num=${roomNum}">
                            Room ë°°ì • ìˆ˜ì •
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
    <nav aria-label="íšŒì› í˜ì´ì§€ë„¤ì´ì…˜">
        <ul class="pagination justify-content-center mt-5">
            <li class="page-item" th:classappend="${members.first} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/membersByHotelRoom/{hotelRoomNum}(hotelRoomNum=${hotelRoomNum}, page=${currentPage - 1})}"
                   th:if="${!members.first}">ì´ì „</a>
                <span class="page-link" th:if="${members.first}">ì´ì „</span>
            </li>

            <li th:each="i : ${#numbers.sequence(0, members.totalPages - 1)}"
                class="page-item active" th:classappend="${currentPage == i} ? 'active'">
                <a class="page-link"
                   th:href="@{/membersByHotelRoom/{hotelRoomNum}(hotelRoomNum=${hotelRoomNum}, page=${i})}"
                   th:text="${i + 1}"></a>
            </li>

            <li class="page-item" th:classappend="${members.last} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/membersByHotelRoom/{hotelRoomNum}(hotelRoomNum=${hotelRoomNum}, page=${currentPage + 1})}"
                   th:if="${!members.last}">ë‹¤ìŒ</a>
                <span class="page-link" th:if="${members.last}">ë‹¤ìŒ</span>
            </li>
        </ul>
    </nav>
</div>

<!-- íšŒì› ê²€ìƒ‰í›„ ìˆ˜ì • ëª¨ë‹¬ Room DB ì— RoomPK  ê¸°ì¤€ìœ¼ë¡œ ê°€ì ¸ì™€ì„œ memberFKë§Œ ë³€ê²½ ê°€ëŠ¥-->
<div class="modal fade" id="memberModal" tabindex="-1" aria-labelledby="memberModalLabel" aria-hidden="true"><!--ê²€ìƒ‰ modal ì‹œì‘ì -->
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="memberModalLabel">íšŒì› ê²€ìƒ‰</h5><!--íšŒì› ê²€ìƒ‰ìœ¼ë¡œ room ë°°ì • ë³€ê²½-->

                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- âœ… ìˆ¨ê²¨ì§„ ë£¸ ë„˜ë²„ input -->
                <input type="hidden" id="roomNumHidden">
                <div class="mb-3">
                    <input type="text" id="memberSearchInput" class="form-control" placeholder="ì´ë¦„ ë˜ëŠ” ì´ë©”ì¼ ê²€ìƒ‰..."/>
                    <button class="btn btn-outline-primary mt-2" type="button" onclick="searchMembers()">ê²€ìƒ‰</button>
                </div>
                <table class="table table-hover">
                    <thead>
                    <tr>
                        <th>ë²ˆí˜¸</th>
                        <th>ì´ë¦„</th>
                        <th>ì´ë©”ì¼</th>
                        <th>ì „í™”ë²ˆí˜¸</th>
                        <th>ì„ íƒ</th>
                    </tr>
                    </thead>
                    <tbody id="memberSearchResults"></tbody>
                </table>
            </div>
        </div>
    </div>
</div><!--ê²€ìƒ‰ modal ëì -->



<!-- íšŒì› ìˆ˜ì • ëª¨ë‹¬ -->
<div class="modal fade" id="editMemberModal" tabindex="-1" aria-labelledby="editMemberModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <form method="post" id="editMemberForm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editMemberModalLabel">íšŒì› ì •ë³´ ìˆ˜ì •</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="memberNum" id="modalMemberNum">
                    <div class="mb-3">
                        <label for="modalMemberName" class="form-label">ì´ë¦„</label>
                        <input type="text" class="form-control" id="modalMemberName" name="memberName" required>
                    </div>
                    <div class="mb-3">
                        <label for="modalMemberPhone" class="form-label">ì „í™”ë²ˆí˜¸</label>
                        <input type="text" class="form-control" id="modalMemberPhone" name="memberPhone" required>
                    </div>
                    <div class="mb-3">
                        <label for="modalMemberEmail" class="form-label">ì´ë©”ì¼</label>
                        <input type="email" class="form-control" id="modalMemberEmail" name="memberEmail" required>
                    </div>
                </div>
                <div class="modal-footer d-flex justify-content-center">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ì €ì¥</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('open-member-modal-btn')) {

            const roomNum = e.target.getAttribute('data-room-num');
            console.log("openMemberModalWithRoomNum í˜¸ì¶œë¨, ì „ë‹¬ëœ roomNum:", roomNum);
            console.log("openMemberModalWithRoomNum í˜¸ì¶œë¨, ì „ë‹¬ëœ roomNum:", roomNum);
            console.log("openMemberModalWithRoomNum í˜¸ì¶œë¨, ì „ë‹¬ëœ roomNum:", roomNum);

            openMemberModalWithRoomNum(roomNum);
        }
    });

    function openMemberModalWithRoomNum(roomNum) {

        console.log("openMemberModalWithRoomNum í˜¸ì¶œë¨, ì „ë‹¬ëœ roomNum:", roomNum); // ì—¬ê¸°ë¥¼ í™•ì¸!
        console.log("openMemberModalWithRoomNum í˜¸ì¶œë¨, ì „ë‹¬ëœ roomNum:", roomNum); // ì—¬ê¸°ë¥¼ í™•ì¸!
        console.log("openMemberModalWithRoomNum í˜¸ì¶œë¨, ì „ë‹¬ëœ roomNum:", roomNum); // ì—¬ê¸°ë¥¼ í™•ì¸!
        console.log("openMemberModalWithRoomNum í˜¸ì¶œë¨, ì „ë‹¬ëœ roomNum:", roomNum); // ì—¬ê¸°ë¥¼ í™•ì¸!
        document.getElementById('roomNumHidden').value = roomNum;

        const modal = new bootstrap.Modal(document.getElementById('memberModal'));
        modal.show();
    }

    function searchMembers() {
        const query = document.getElementById('memberSearchInput').value;
        if (!query.trim()) {
            alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        fetch(`/admin/member/search?keyword=${encodeURIComponent(query)}`)
            .then(res => {
                if (!res.ok) throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${res.status}`);
                return res.json();
            })
            .then(data => {
                const tbody = document.getElementById('memberSearchResults');
                tbody.innerHTML = "";
                if (data.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='5' class='text-center'>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
                    return;
                }

                const roomNum = document.getElementById('roomNumHidden').value;

                data.forEach(member => {
                    const row = `
                    <tr>
                        <td>${member.memberNum}</td>
                        <td>${member.memberName}</td>
                        <td>${member.memberEmail}</td>
                        <td>${member.memberPhone}</td>
                        <td>
                            <button type="button" class="btn btn-sm btn-primary select-member-btn"
                                data-room-num="${roomNum}"
                                data-member-num="${member.memberNum}"
                                data-member-name="${member.memberName}"
                                data-member-email="${member.memberEmail}"
                                data-member-phone="${member.memberPhone}">
                                ê²€ìƒ‰ìˆ˜ì •
                            </button>
                        </td>
                    </tr>`;
                    tbody.insertAdjacentHTML("beforeend", row);
                });
            })
            .catch(error => {
                console.error("íšŒì› ê²€ìƒ‰ ì˜¤ë¥˜:", error);
                alert("íšŒì› ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
    }

    document.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('select-member-btn')) {

            const btn = e.target;
            const memberNum = btn.getAttribute('data-member-num');
            // const roomNum = btn.getAttribute('data-room-num');  âœ… roomNumì€ ë‚´ë¶€ì—ì„œ ê°€ì ¸ì˜¤ë„ë¡

            selectMember(memberNum);
        }
    });




    function selectMember(memberNum) {

        const roomNum = document.getElementById('roomNumHidden').value;

        /*roomNum MemberNum ë‹¤ ë“¤ì–´ì™€ì•¼ í•¨ ë“¤ì–´ ì™€ë¼ ì œë°œ ì œë°œ */
        console.log("roomNum:", roomNum, "memberNum:", memberNum+"ë£¸í‚¤ë‘ ë©¤ë²„í‚¤ ë“¤ì˜¤ì˜¤ê¸°ëŠ” í•˜ë‹ˆ ì™œ ì•ˆë“¤ì–´ ì˜¤ëƒêµ¬");
        console.log("roomNum:", roomNum, "memberNum:", memberNum+"ë£¸í‚¤ë‘ ë©¤ë²„í‚¤ ë“¤ì˜¤ì˜¤ê¸°ëŠ” í•˜ë‹ˆ ì™œ ì•ˆë“¤ì–´ ì˜¤ëƒêµ¬");
        console.log("roomNum:", roomNum, "memberNum:", memberNum+"ë£¸í‚¤ë‘ ë©¤ë²„í‚¤ ë“¤ì˜¤ì˜¤ê¸°ëŠ” í•˜ë‹ˆ ì™œ ì•ˆë“¤ì–´ ì˜¤ëƒêµ¬");
        console.log("roomNum:", roomNum, "memberNum:", memberNum+"ë£¸í‚¤ë‘ ë©¤ë²„í‚¤ ë“¤ì˜¤ì˜¤ê¸°ëŠ” í•˜ë‹ˆ ì™œ ì•ˆë“¤ì–´ ì˜¤ëƒêµ¬");


        if (!roomNum || !memberNum) {
            alert("í•„ìˆ˜ ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.");
            return;
        }

        if (!confirm("ì„ íƒí•œ íšŒì›ìœ¼ë¡œ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        fetch("/admin/room/update-member", {
            method: "POST",
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `roomNum=${roomNum}&memberNum=${memberNum}`
        })
            .then(res => {
                if (!res.ok) throw new Error("íšŒì› ìˆ˜ì • ì‹¤íŒ¨");
                return res.text();
            })
            .then(msg => {
                alert(msg);
                const modal = bootstrap.Modal.getInstance(document.getElementById('memberModal'));
                modal.hide();
                location.reload();
            })
            .catch(err => {
                console.error("íšŒì› ë³€ê²½ ì¤‘ ì˜¤ë¥˜:", err);
                alert("íšŒì› ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });

    }





        /*ìˆ˜ë™ modal ìˆ˜ì • script ë©”ì†Œë“œ*/
        // ğŸŸ¢ DOMì´ ë¡œë“œëœ í›„ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', function () {
            const editMemberModal = document.getElementById('editMemberModal');
            editMemberModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                document.getElementById('modalMemberNum').value = button.getAttribute('data-member-num');
                document.getElementById('modalMemberName').value = button.getAttribute('data-member-name');
                document.getElementById('modalMemberPhone').value = button.getAttribute('data-member-phone');
                document.getElementById('modalMemberEmail').value = button.getAttribute('data-member-email');
            });

            const editMemberForm = document.getElementById('editMemberForm');
            editMemberForm.addEventListener('submit', function (event) {
                event.preventDefault();

                const formData = {
                    memberNum: document.getElementById('modalMemberNum').value,
                    memberName: document.getElementById('modalMemberName').value,
                    memberPhone: document.getElementById('modalMemberPhone').value,
                    memberEmail: document.getElementById('modalMemberEmail').value
                };

                fetch('/member/update/ajax', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(formData)
                })
                    .then(response => {
                        if (response.ok) {
                            alert("âœ… ìˆ˜ì • ì™„ë£Œ");
                            window.location.reload();
                        } else {
                            return response.text().then(text => {
                                throw new Error(text);
                            });
                        }
                    })
                    .catch(error => {
                        alert("âŒ ìˆ˜ì • ì‹¤íŒ¨: " + error.message);
                    });
            });
        });

</script>

</body>
</html>
