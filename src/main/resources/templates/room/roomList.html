<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout.html}">
<head>
    <meta charset="UTF-8">
    <title>ê°ì‹¤ ì˜ˆì•½ ëª©ë¡</title>
    <style>
        .table td {
            vertical-align: middle;
            font-size: 0.85rem;
        }

        .table {
            width: 100%;
            table-layout: fixed; /* ê³ ì •ëœ í…Œì´ë¸” ë„ˆë¹„ ì„¤ì • */
        }

        .btn-checkin {
            background-color: #0d6efd; /* íŒŒë€ìƒ‰ */
            color: white;
        }

        .btn-checkout {
            background-color: #dc3545; /* ë¹¨ê°„ìƒ‰ */
            color: white;
        }

        .btn-checkin:hover {
            background-color: #0b5ed7;
        }

        .btn-checkout:hover {
            background-color: #bb2d3b;
        }
    </style>
</head>
<body style="background-color: #f8f9fa;">
<div layout:fragment="content">

    <div class="container mt-4 w-100 bg-light">
        <h2 class="fw-bold mb-4 text-center" >ê°ì‹¤ ì˜ˆì•½ ëª©ë¡</h2>

        <!-- ê²€ìƒ‰ í¼ -->
        <form action="/roomlist" method="get" class="d-flex align-items-end gap-2">

            <div class="flex-grow-1">
                <input name="keyword" type="text" class="form-control"
                       placeholder="íšŒì› ì´ë¦„ ë˜ëŠ” ì´ë©”ì¼ë¡œ ê²€ìƒ‰" th:value="${keyword}">
            </div>

            <div class="d-flex gap-2">
                <button type="submit" id="searchBtn" class="btn btn-primary">ê²€ìƒ‰</button>
                <a th:href="@{/register-hotelroom}" class="btn btn-success">íšŒì› ê°ì‹¤ ë°°ì •</a>
                <a th:href="@{/member-insertroom}" class="btn btn-outline-success">ë¹„íšŒì› ê°ì‹¤ ë°°ì •</a>
            </div>

        </form>

        <div class="d-flex justify-content-center mt-4 gap-3">
            <a th:href="@{/roomlist/checkin}"
               class="text-decoration-none text-primary"
               th:classappend="${currentStatus} == 'checkin' ? 'border-bottom border-primary' : ''">
                ì²´í¬ì¸ ëª©ë¡
            </a>
            <span>|</span>
            <a th:href="@{/roomlist/checkout}"
               class="text-decoration-none text-danger"
               th:classappend="${currentStatus} == 'checkout' ? 'border-bottom border-danger' : ''">
                ì²´í¬ì•„ì›ƒ ëª©ë¡
            </a>
            <span>|</span>
            <a th:href="@{/roomlist}"
               class="text-decoration-none text-dark">
                ì „ì²´ ëª©ë¡
            </a>
        </div>

        <!-- í…Œì´ë¸” -->
        <div class="row mt-4">
            <div class="col-12">
                <table class="table table-bordered text-company mb-0" style="table-layout: fixed; width: 100%;">
                    <thead class="table-light text-center">
                    <tr>
                        <th style="width: 5%;">ë²ˆí˜¸</th>
                        <th style="width: 13%;">ê°ì‹¤ëª…</th>
                        <th style="width: 11%;">íšŒì› ì´ë¦„</th>
                        <th style="width: 17%;">íšŒì› ì´ë©”ì¼</th>
                        <th style="width: 10%;">ê°ì‹¤ ì—°ë½ì²˜</th>
                        <th style="width: 8%;">ì²´í¬ì¸</th>
                        <th style="width: 8%;">ì²´í¬ì•„ì›ƒ</th>
                        <th style="width: 10%;">ê°ì‹¤ ë¹„ë°€ë²ˆí˜¸</th>
                        <th style="width: 9%;">í˜„ì¬ ìƒíƒœ</th>
                        <th style="width: 9%;">ìƒíƒœ ë³€ê²½</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="room : ${rooms.content}">
                        <td class="text-center text-truncate" th:text="${room.roomNum}"></td>
                        <td class="text-center text-truncate">
                            <a href="javascript:void(0);"
                               onclick="openHotelRoomPopup(this)"
                               class="hover-grow-text d-inline-block text-truncate w-100"
                               th:attr="data-hotelRoomNum=${room.hotelRoomNum}, data-roomNum=${room.roomNum}"
                               th:text="${room.hotelRoomName}"></a>
                        </td>
                        <td class="text-center text-truncate">
                            <a href="javascript:void(0);"
                               onclick="openMemberPopup(this)"
                               class="hover-grow-text d-inline-block text-truncate w-100"
                               th:attr="data-memberNum=${room.memberNum}, data-roomNum=${room.roomNum}"
                               th:text="${room.memberName}"></a>
                        </td>
                        <td class="text-center text-truncate" th:text="${room.memberEmail}"></td>
                        <td class="text-center text-truncate" th:text="${room.hotelRoomPhone}"></td>
                        <td class="text-center text-truncate">
                            <span th:text="${#temporals.format(room.checkInDate, 'yy-MM-dd')}"></span><br>
                            <span th:text="${#temporals.format(room.checkInDate, 'HH:mm')}"></span>
                        </td>
                        <td class="text-center text-truncate">
                            <span th:text="${#temporals.format(room.checkOutDate, 'yy-MM-dd')}"></span><br>
                            <span th:text="${#temporals.format(room.checkOutDate, 'HH:mm')}"></span>
                        </td>

                        <td class="text-center text-danger text-truncate" th:text="${room.roomPassword}"></td>
                        <td class="text-center text-truncate"
                            th:text="${room.hotelRoomStatus == 'checkin' ? 'ì‚¬ìš©ì¤‘' : (room.hotelRoomStatus == 'checkout' ? 'ë¹„ì–´ìˆìŒ' : room.hotelRoomStatus)}">
                        </td>
                        <!-- ì„¸ì˜ë‹˜ ì—¬ê¸° ë¶€ë¶™ ìˆ˜ì • í•´ì£¼ì„¸ìš” ë°œì†¡ ë²„íŠ¼ (roomNum ê¸°ë°˜ìœ¼ë¡œ ìš”ì²­ ë³´ëƒ„) -->
                        <form method="post" th:action="@{'/room/resend-mail/' + ${room.roomNum}}" style="display:inline;">
                            <button type="submit" class="btn btn-sm btn-outline-primary">
                                [[${room.roomNum}]]âœ‰ ë©”ì¼ ì¬ë°œì†¡
                            </button>
                        </form>

                        <td class="text-center">
                            <div class="d-flex flex-column align-items-center gap-1">

                                <!--ì²´í¬ì¸ ë²„íŠ¼ (ì²´í¬ì•„ì›ƒ ìƒíƒœì¼ ë•Œë§Œ ë…¸ì¶œ) -->
                                <button th:if="${room.hotelRoomStatus} == 'checkout'"
                                        class="btn btn-sm btn-primary btn-checkin"
                                        th:text="'ì²´í¬ì¸'"
                                        th:attr="data-hotelRoomNum=${room.hotelRoomNum}, data-status='checkin'"
                                        onclick="roomStatusUpdate(this)">
                                </button>

                                <!-- ì²´í¬ì•„ì›ƒ ë²„íŠ¼ (ì²´í¬ì¸ ìƒíƒœì¼ ë•Œë§Œ ë…¸ì¶œ) -->
                                <button th:if="${room.hotelRoomStatus} == 'checkin'"
                                        class="btn btn-sm btn-danger btn-checkout"
                                        th:text="ì²´í¬ì•„ì›ƒ"
                                        th:attr="data-hotelRoomNum=${room.hotelRoomNum}, data-status='checkout'"
                                        onclick="roomStatusUpdate(this)">
                                </button>
                            </div>
                        </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(rooms.content)}">
                        <td colspan="9" class="text-center text-muted">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
    <div class="d-flex justify-content-center align-items-center mt-3">
        <nav>
            <ul class="pagination mb-0">

                <!-- ì´ì „ -->
                <!-- ì´ì „ ë²„íŠ¼ -->
                <li class="page-item" th:classappend="${rooms.first} ? 'disabled'">
                    <a class="page-link"
                       th:href="${currentStatus} != null ?
                @{/roomlist/{status}(status=${currentStatus}, page=${rooms.number - 1})} :
                @{/roomlist(page=${rooms.number - 1})}">
                        ì´ì „
                    </a>
                </li>

                <!-- ë²ˆí˜¸ ë²„íŠ¼ -->
                <li th:each="i : ${#numbers.sequence(0, rooms.totalPages - 1)}"
                    class="page-item" th:classappend="${rooms.number == i} ? 'active'">
                    <a class="page-link"
                       th:href="${currentStatus} != null ?
                @{/roomlist/{status}(status=${currentStatus}, page=${i})} :
                @{/roomlist(page=${i})}"
                       th:text="${i + 1}"></a>
                </li>

                <!-- ë‹¤ìŒ ë²„íŠ¼ -->
                <li class="page-item" th:classappend="${rooms.last} ? 'disabled'">
                    <a class="page-link"
                       th:href="${currentStatus} != null ?
                @{/roomlist/{status}(status=${currentStatus}, page=${rooms.number + 1})} :
                @{/roomlist(page=${rooms.number + 1})}">
                        ë‹¤ìŒ
                    </a>
                </li>
            </ul>
        </nav>
    </div>


    <script th:inline="javascript">

        function roomStatusUpdate(element) {
            const hotelRoomNum = element.getAttribute("data-hotelRoomNum");
            const status = element.getAttribute("data-status");

            if (status == "checkin") {
                if (!confirm("ì²´í¬ì¸ ìƒíƒœë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            } else if (status == "checkout") {
                if (!confirm("ì²´í¬ì•„ì›ƒ ìƒíƒœë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            }

            fetch(`/admin/hotelroom/checkinout/${hotelRoomNum}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status: status })
            })
                .then(res => {
                    if (!res.ok) {
                        alert(`${status} ì²˜ë¦¬ ì‹¤íŒ¨`);
                        return;
                    }

                    alert(`${status === 'checkin' ? 'ì²´í¬ì¸' : 'ì²´í¬ì•„ì›ƒ'} ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    location.reload();  // âœ… ìƒˆë¡œê³ ì¹¨í•˜ë©´ ë!
                })
                .catch(err => {
                    console.error(err);
                    alert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                });
        }


        /*<!--Room ì •ë³´ í´ë¦­ì‹œ íŒì—… ìŠ¤í¬ë¦½íŠ¸ -->*/
        function openHotelRoomPopup(element) {
            const hotelRoomNum = element.getAttribute("data-hotelRoomNum");
            const roomNum = element.getAttribute("data-roomNum");

            if (!hotelRoomNum) return alert("í˜¸í…” ê°ì‹¤ ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            if (!roomNum) return alert("ê°ì‹¤ ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

            // hotelRoomNumì€ path variable, roomNumì€ query paramìœ¼ë¡œ ì „ë‹¬
            const popupUrl = `/membersByHotelRoom/${hotelRoomNum}?roomNum=${roomNum}`;

            const popupWidth = 1200;
            const popupHeight = 700;

            const screenLeft = window.screenLeft !== undefined ? window.screenLeft : window.screenX;
            const screenTop = window.screenTop !== undefined ? window.screenTop : window.screenY;
            const width = window.innerWidth || document.documentElement.clientWidth || screen.width;
            const height = window.innerHeight || document.documentElement.clientHeight || screen.height;

            const left = screenLeft + (width - popupWidth) / 2;
            const top = screenTop + (height - popupHeight) / 2;

            const newWindow = window.open(
                popupUrl,
                "room/membersByHotelRoom",
                `width=${popupWidth},height=${popupHeight},left=${left},top=${top},scrollbars=yes,resizable=yes`
            );

            if (window.focus && newWindow) {
                newWindow.focus();
            }
        }

        <!--member ì •ë³´ í´ë¦­ì‹œ íŒì—… ìŠ¤í¬ë¦½íŠ¸ -->
        function openMemberPopup(element) {
            const memberNum = element.getAttribute("data-memberNum");
            const roomNum = element.getAttribute("data-roomNum"); // ğŸ”¥ ì¶”ê°€ëœ ë¶€ë¶„

            if (!memberNum) return alert("íšŒì› ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            if (!roomNum) return alert("ê°ì‹¤ ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

            const popupUrl = `/hotelRoomsByMember/${memberNum}?roomNum=${roomNum}`;

            // íŒì—… ê¸°ë³¸ ì‚¬ì´ì¦ˆ
            const popupWidth = 1200;
            const popupHeight = 600;

            // í™”ë©´ ê°€ìš´ë° ìœ„ì¹˜ ê³„ì‚°
            const screenLeft = window.screenLeft !== undefined ? window.screenLeft : window.screenX;
            const screenTop = window.screenTop !== undefined ? window.screenTop : window.screenY;

            const width = window.innerWidth || document.documentElement.clientWidth || screen.width;
            const height = window.innerHeight || document.documentElement.clientHeight || screen.height;

            const left = screenLeft + (width - popupWidth) / 2;
            const top = screenTop + (height - popupHeight) / 2;

            // íŒì—… ì—´ê¸°
            const newWindow = window.open(
                popupUrl,
                "room/hotelRoomsByMember",
                `width=${popupWidth},height=${popupHeight},left=${left},top=${top},scrollbars=yes,resizable=yes`
            );

            // íŒì—… í¬ì»¤ìŠ¤
            if (window.focus && newWindow) {
                newWindow.focus();
            }
        }
    </script>
</div>

</div><!--ë ˆì´ì•„ì›ƒ fragment ëì  -->



</body>
</html>
