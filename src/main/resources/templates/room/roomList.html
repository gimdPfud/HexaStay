<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout.html}">
<head>
    <meta charset="UTF-8">
    <title>Room 예약 목록</title>
    <style>
        .table td {
            vertical-align: middle;
        }

        .table {
            width: 100%;
            table-layout: fixed; /* 고정된 테이블 너비 설정 */
        }
        .btn-checkin {
            background-color: #0d6efd; /* 파란색 */
            color: white;
            font-weight: bold;
        }

        .btn-checkout {
            background-color: #dc3545; /* 빨간색 */
            color: white;
            font-weight: bold;
        }

        .btn-checkin:hover {
            background-color: #0b5ed7;
        }

        .btn-checkout:hover {
            background-color: #bb2d3b;
        }
    </style>
</head>
<body style="background-color: #f8f9fa;">
<div layout:fragment="content">

    <div class="container mt-4 w-100 bg-light">
        <h2 class="fw-bold mb-4 text-center" >객실 예약 목록</h2>

        <!-- 검색 폼 -->
        <form action="/roomlist" method="get" class="row g-3 align-items-end">
            <div class="col-md-10" style=" width: 70%;">
                <input name="keyword" type="text" class="form-control" style="height: 40px; font-size: 0.9rem;" placeholder="회원 이름 또는 이메일로 검색" th:value="${keyword}">
            </div>

            <div class="col-md-2 d-flex gap-3" style=" width: 30%;">
                <button type="submit" id="searchBtn" class="btn btn-primary w-50" style="height: 40px; font-size: 0.9rem;">검색</button>
                <a href="/roomlist" class="btn btn-secondary w-50" style="height: 40px; font-size: 0.9rem;">초기화</a>
            </div>
        </form>

        <!-- 테이블 -->
        <div class="row mt-4">
            <div class="col-12">
                <table class="table table-bordered text-company mb-0" style="table-layout: fixed; width: 100%;">
                    <thead class="table-light text-center">
                    <tr>
                        <th style="width: 5%;">번호</th>
                        <th style="width: 12%;">룸 명</th>
                        <th style="width: 12%;">회원 이름</th>
                        <th style="width: 18%;">회원 이메일</th>
                        <th style="width: 12%;">룸 연락처</th>
                        <th style="width: 10%;">체크인</th>
                        <th style="width: 10%;">체크아웃</th>
                        <th style="width: 10%;">룸 비밀번호</th>
                        <th style="width: 11%;">룸 상태 변경</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="room : ${rooms.content}">
                        <td class="text-center text-truncate" th:text="${room.roomNum}"></td>
                        <td class="text-center text-truncate">
                            <a href="javascript:void(0);"
                               onclick="openHotelRoomPopup(this)"
                               class="hover-grow-text d-inline-block text-truncate w-100"
                               th:attr="data-hotelRoomNum=${room.hotelRoomNum}, data-roomNum=${room.roomNum}"
                               th:text="${room.hotelRoomName}"></a>
                        </td>
                        <td class="text-center text-truncate">
                            <a href="javascript:void(0);"
                               onclick="openMemberPopup(this)"
                               class="hover-grow-text d-inline-block text-truncate w-100"
                               th:attr="data-memberNum=${room.memberNum}, data-roomNum=${room.roomNum}"
                               th:text="${room.memberName}"></a>
                        </td>
                        <td class="text-center text-truncate" th:text="${room.memberEmail}"></td>
                        <td class="text-center text-truncate" th:text="${room.hotelRoomPhone}"></td>
                        <td class="text-center text-truncate" th:text="${#temporals.format(room.checkInDate, 'yyyy-MM-dd HH:mm')}"></td>
                        <td class="text-center text-truncate" th:text="${#temporals.format(room.checkOutDate, 'yyyy-MM-dd HH:mm')}"></td>
                        <td class="text-center text-danger text-truncate" th:text="${room.roomPassword}"></td>
                        <td class="text-center">
                            <div class="d-flex flex-column align-items-center gap-1">

                                <!--체크인 버튼 (체크아웃 상태일 때만 노출) -->
                                <button th:if="${room.hotelRoomStatus} == 'checkout'"
                                        class="btn btn-sm btn-primary btn-checkin"
                                        th:text="'체크인'"
                                        th:attr="data-hotelRoomNum=${room.hotelRoomNum}, data-status='checkin'"
                                        onclick="roomStatusUpdate(this)">
                                </button>

                                <!-- 체크아웃 버튼 (체크인 상태일 때만 노출) -->
                                <button th:if="${room.hotelRoomStatus} == 'checkin'"
                                        class="btn btn-sm btn-danger btn-checkout"
                                        th:text="체크아웃"
                                        th:attr="data-hotelRoomNum=${room.hotelRoomNum}, data-status='checkout'"
                                        onclick="roomStatusUpdate(this)">
                                </button>
                            </div>
                        </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(rooms.content)}">
                        <td colspan="9" class="text-center text-muted">검색 결과가 없습니다.</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 페이지네이션 -->
    <div class="d-flex justify-content-center align-items-center mt-3">
        <nav>
            <ul class="pagination mb-0">

                <!-- 이전 -->
                <!-- 이전 버튼 -->
                <li class="page-item" th:classappend="${rooms.first} ? 'disabled'">
                    <a class="page-link"
                       th:href="${currentStatus} != null ?
                @{/roomlist/{status}(status=${currentStatus}, page=${rooms.number - 1})} :
                @{/roomlist(page=${rooms.number - 1})}">
                        이전
                    </a>
                </li>

                <!-- 번호 버튼 -->
                <li th:each="i : ${#numbers.sequence(0, rooms.totalPages - 1)}"
                    class="page-item" th:classappend="${rooms.number == i} ? 'active'">
                    <a class="page-link"
                       th:href="${currentStatus} != null ?
                @{/roomlist/{status}(status=${currentStatus}, page=${i})} :
                @{/roomlist(page=${i})}"
                       th:text="${i + 1}"></a>
                </li>

                <!-- 다음 버튼 -->
                <li class="page-item" th:classappend="${rooms.last} ? 'disabled'">
                    <a class="page-link"
                       th:href="${currentStatus} != null ?
                @{/roomlist/{status}(status=${currentStatus}, page=${rooms.number + 1})} :
                @{/roomlist(page=${rooms.number + 1})}">
                        다음
                    </a>
                </li>
            </ul>
        </nav>
    </div>

    <!-- 하단 버튼 -->
    <div class="d-flex justify-content-center mt-4 gap-3">
        <a th:href="@{/register-hotelroom}" class="btn btn-dark" style="height: 40px; font-size: 0.9rem;">회원 룸배정</a><!--todo:http://localhost:8090/register-hotelroom-->
        <a th:href="@{/member-insertroom}" class="btn btn-danger" style="height: 40px; font-size: 0.9rem;">비회원 룸배정</a><!--todo:http://localhost:8090/member-insertroom-->
        <a th:href="@{/roomlist/checkin}"
           class="btn btn-outline-primary"
           th:classappend="${currentStatus} == 'checkin' ? ' active fw-bold text-white bg-primary border-primary' : ''">
            체크인 목록
        </a>

        <a th:href="@{/roomlist/checkout}"
           class="btn btn-outline-danger"
           th:classappend="${currentStatus} == 'checkout' ? ' active fw-bold text-white bg-danger border-danger' : ''">
            체크아웃 목록
        </a>
        <a th:href="@{/roomlist}"
           class="btn btn-outline-primary">
            전체 리스트
        </a>

    </div>


    <script th:inline="javascript">

            /*체크인 체크 아웃 상태 */
            function roomStatusUpdate(element) {

                const hotelRoomNum = element.getAttribute("data-hotelRoomNum");
                const status = element.getAttribute("data-status");  // 'checkin' 또는 'checkout'


                if (status == "checkin") {
                    const check = confirm("체크 IN 상태로 변경 하시겠습니까");
                    if (check == false) {
                        return;
                    }
                    alert("체크 IN 되었습니다.")
                }else if (status == "checkout") {
                    const check = confirm("체크 OUT 상태로 변경 하시겠습니까")
                    if (check == false) {
                        return;
                    }
                    alert("체크 OUT 되었습니다.")
                }


                fetch(`/admin/hotelroom/checkinout/${hotelRoomNum}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: status })
                })
                    .then(res => {
                        if (!res.ok) {
                            alert(`${status} 처리 실패`);
                            return;
                        }

                        // ✅ 버튼 전환 (reload 대신)
                        const parent = element.parentElement;
                        parent.innerHTML = ''; // 기존 버튼 제거

                        if (status === 'checkin') {
                            parent.innerHTML = `
                    <button class="btn btn-sm btn-checkout"
                            data-hotelRoomNum="${hotelRoomNum}"
                            data-status="checkout"
                            onclick="roomStatusUpdate(this)">체크아웃</button>`;
                        } else {
                            parent.innerHTML = `
                    <button class="btn btn-sm btn-checkin"
                            data-hotelRoomNum="${hotelRoomNum}"
                            data-status="checkin"
                            onclick="roomStatusUpdate(this)">체크인</button>`;
                        }
                    });
            }



        /*<!--Room 정보 클릭시 팝업 스크립트 -->*/
        function openHotelRoomPopup(element) {
            const hotelRoomNum = element.getAttribute("data-hotelRoomNum");
            const roomNum = element.getAttribute("data-roomNum");

            if (!hotelRoomNum) return alert("호텔룸 번호를 찾을 수 없습니다.");
            if (!roomNum) return alert("룸 번호를 찾을 수 없습니다.");

            // hotelRoomNum은 path variable, roomNum은 query param으로 전달
            const popupUrl = `/membersByHotelRoom/${hotelRoomNum}?roomNum=${roomNum}`;

            const popupWidth = 1200;
            const popupHeight = 700;

            const screenLeft = window.screenLeft !== undefined ? window.screenLeft : window.screenX;
            const screenTop = window.screenTop !== undefined ? window.screenTop : window.screenY;
            const width = window.innerWidth || document.documentElement.clientWidth || screen.width;
            const height = window.innerHeight || document.documentElement.clientHeight || screen.height;

            const left = screenLeft + (width - popupWidth) / 2;
            const top = screenTop + (height - popupHeight) / 2;

            const newWindow = window.open(
                popupUrl,
                "room/membersByHotelRoom",
                `width=${popupWidth},height=${popupHeight},left=${left},top=${top},scrollbars=yes,resizable=yes`
            );

            if (window.focus && newWindow) {
                newWindow.focus();
            }
        }

        <!--member 정보 클릭시 팝업 스크립트 -->
        function openMemberPopup(element) {
            const memberNum = element.getAttribute("data-memberNum");
            const roomNum = element.getAttribute("data-roomNum"); // 🔥 추가된 부분

            if (!memberNum) return alert("회원 번호를 찾을 수 없습니다.");
            if (!roomNum) return alert("룸 번호를 찾을 수 없습니다.");

            const popupUrl = `/hotelRoomsByMember/${memberNum}?roomNum=${roomNum}`;

            // 팝업 기본 사이즈
            const popupWidth = 1200;
            const popupHeight = 600;

            // 화면 가운데 위치 계산
            const screenLeft = window.screenLeft !== undefined ? window.screenLeft : window.screenX;
            const screenTop = window.screenTop !== undefined ? window.screenTop : window.screenY;

            const width = window.innerWidth || document.documentElement.clientWidth || screen.width;
            const height = window.innerHeight || document.documentElement.clientHeight || screen.height;

            const left = screenLeft + (width - popupWidth) / 2;
            const top = screenTop + (height - popupHeight) / 2;

            // 팝업 열기
            const newWindow = window.open(
                popupUrl,
                "room/hotelRoomsByMember",
                `width=${popupWidth},height=${popupHeight},left=${left},top=${top},scrollbars=yes,resizable=yes`
            );

            // 팝업 포커스
            if (window.focus && newWindow) {
                newWindow.focus();
            }
        }
    </script>
</div>

</div><!--레이아웃 fragment 끝점 -->



</body>
</html>
