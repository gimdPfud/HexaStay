<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout.html}">
<head>
    <meta charset="UTF-8">
    <title>HotelRoom ë°°ì • ë“±ë¡(íšŒì›í™•ì¸)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
<div layout:fragment="content" class="container mt-4"><!--ë ˆì´ì•„ì›ƒ fragment ì‹œì‘ì -->

    <div class="container mt-5"><!--ìˆ™ë°• ì˜ˆì•½ë“±ë¡ ì‹œì‘ ì§€ì  -->
        <h2 class="mb-4">HotelRoom ë°°ì • ë“±ë¡íšŒì›ê²€ìƒ‰_í˜¸í…”ë£¸ ê²€ìƒ‰</h2>

        <!-- Flash ë©”ì‹œì§€ í‘œì‹œ -->
        <div th:if="${successMessage}" class="alert alert-success" role="alert">
            <span th:text="${successMessage}"></span>
        </div>
        <div th:if="${errorMessage}" class="alert alert-danger" role="alert">
            <span th:text="${errorMessage}"></span>
        </div>

        <form th:action="@{/register-hotelroom}" th:object="${hotelRoomDTO}" method="post" class="row g-3">
            <!-- íšŒì› ì„ íƒ ë²„íŠ¼ -->
            <div class="col-md-6">
                <label class="form-label">Member_PK:</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="memberNum" name="memberNum" th:field="*{memberNum}" readonly required />
                    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#memberModal">ê²€ìƒ‰</button>
                </div>
            </div>

            <div class="col-md-6">
                <label class="form-label">íšŒì› ì´ë¦„:</label>
                <input type="text" class="form-control" id="memberName" th:field="*{memberDTO.memberName}" readonly />
            </div>

            <!--ì´ë¶€ë¶„ì€ ìˆ˜ì • í•´ì•¼ í• ê²ƒ ì…ë‹ˆë‹¤. -->
            <!-- ì²´í¬ì¸/ì²´í¬ì•„ì›ƒ/ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ -->

            <div class="row mt-3">
                <div class="col-md-4">
                    <label for="checkInDate" class="form-label">ì²´í¬ì¸ ë‚ ì§œ</label>
                    <input type="date" class="form-control" id="checkInDate" name="checkInDate" th:field="*{checkInDate}" required />
                </div>
                <div class="col-md-4">
                    <label for="checkOutDate" class="form-label">ì²´í¬ì•„ì›ƒ ë‚ ì§œ</label>
                    <input type="date" class="form-control" id="checkOutDate" name="checkOutDate" th:field="*{checkOutDate}" required />
                </div>
                <div class="col-md-4">
                    <label for="roomPassword" class="form-label">ë£¸ ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="number" class="form-control" id="roomPassword" name="roomPassword" th:field="*{hotelRoomPassword}"  placeholder="ìˆ«ì 4ìë¦¬" required />
                </div>
            </div>

            <div class="mt-4">
                <h4>í˜¸í…”ë£¸ ì„ íƒ</h4>
                <div class="row" id="hotelRoomList"></div>
                <div class="d-flex justify-content-center mt-3" id="paginationControls"></div>
            </div>
            <input type="hidden" id="hotelRoomNum" name="hotelRoomNum" th:field="*{hotelRoomNum}" />




            <div class="col-12">
                <button type="submit" class="btn btn-primary btn-lg">MemberPK_ë“±ë¡</button>
                <a th:href="@{/member-insertroom}" class="btn btn-warning btn-lg">HotelRoomPk_ë£¸ë°°ì •</a>
                <a th:href="@{/roomlist}" class="btn btn-secondary btn-lg">í˜¸í…”ë£¸ ëª©ë¡</a>
            </div>
        </form>
        <!-- í˜ì´ì§€ë„¤ì´ì…˜ ì»¨íŠ¸ë¡¤ì€ ë°–ì—ì„œ ë…ë¦½ì ìœ¼ë¡œ ìœ„ì¹˜ -->
        <div class="d-flex justify-content-center mt-3" id="hotelRoomPagination"></div>


    </div><!--ìˆ™ë°•ì˜ˆì•½ ë“±ë¡ ë ì§€ì -->

    <!-- íšŒì› ê²€ìƒ‰ ëª¨ë‹¬ -->
    <div class="modal fade" id="memberModal" tabindex="-1" aria-labelledby="memberModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="memberModalLabel">íšŒì› ê²€ìƒ‰</h5>
                    <button type="button" id="modalexit" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <!-- ê²€ìƒ‰ì°½ -->
                    <div class="mb-3">
                        <input type="text" id="memberSearchInput" class="form-control" placeholder="ì´ë¦„ ë˜ëŠ” ì´ë©”ì¼ ê²€ìƒ‰..."  />
                        <button class="btn btn-outline-primary" type="button" onclick="searchMembers()">ê²€ìƒ‰</button>
                    </div>

                    <!-- ê²€ìƒ‰ ê²°ê³¼ í…Œì´ë¸” -->
                    <table class="table table-hover">
                        <thead>
                        <tr>
                            <th>ë²ˆí˜¸</th>
                            <th>ì´ë¦„</th>
                            <th>ì´ë©”ì¼</th>
                            <th>ì„ íƒ</th>
                        </tr>
                        </thead>
                        <tbody id="memberSearchResults">
                        <!-- JavaScriptë¡œ ì±„ì›Œì§ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript ì˜ì—­ -->
    <script th:inline="javascript">
        // íšŒì› ê²€ìƒ‰ ìš”ì²­ í•¨ìˆ˜
        function searchMembers() {
            const query = document.getElementById('memberSearchInput').value;
            if (!query.trim()) {
                alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            fetch(`/admin/member/search?keyword=${query}`)
                .then(res => res.json())
                .then(data => {
                    const tbody = document.getElementById('memberSearchResults');
                    tbody.innerHTML = "";

                    if (data.length === 0) {
                        tbody.innerHTML = "<tr><td colspan='4' class='text-center'>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
                        return;
                    }

                    data.forEach(member => {
                        const row = `
                            <tr>
                                <td>${member.memberNum}</td>
                                <td>${member.memberName}</td>
                                <td>${member.memberEmail}</td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-primary" onclick="selectMember(${member.memberNum}, '${member.memberName}')">
                                        ì„ íƒ
                                    </button>
                                </td>
                            </tr>`;
                        tbody.insertAdjacentHTML("beforeend", row);
                    });
                })
                .catch(error => {
                    console.error("íšŒì› ê²€ìƒ‰ ì˜¤ë¥˜:", error);
                    alert("íšŒì› ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                });
        }

        // íšŒì› ì„ íƒ í›„ ëª¨ë‹¬ ë‹«ê¸°
        function selectMember(memberNum, memberName) {
            document.getElementById("memberNum").value = memberNum;
            document.getElementById("memberName").value = memberName;


            // âœ… getOrCreateInstance ë¥¼ ì‚¬ìš©í•˜ë©´ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•Šì€ ëª¨ë‹¬ë„ ì•ˆì „í•˜ê²Œ ë‹«í˜
            // modalexit ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ëª¨ë‹¬ì„ ë‹«ê¸°
            const modalExitButton = document.getElementById('modalexit');
            modalExitButton.click(); // ëª¨ë‹¬ ë‹«ê¸°


        }




            // í˜ì´ì§€ ë¡œë“œì‹œ memberNumì´ ì´ë¯¸ ì…ë ¥ë¼ ìˆë‹¤ë©´ ì´ë¦„ ë¶ˆëŸ¬ì˜¤ê¸°
            function fetchMemberName() {
            const memberNum = document.getElementById("memberNum").value;
            if (!memberNum) return;

            fetch(`/admin/member/find?memberNum=` + memberNum)
            .then(res => res.ok ? res.json() : Promise.reject("íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤"))
            .then(data => {
            document.getElementById("memberName").value = data.memberName;
        })
            .catch(err => {
            alert("âŒ íšŒì› ì¡°íšŒ ì‹¤íŒ¨: " + err);
            document.getElementById("memberName").value = "";
        });
        }

            // í˜ì´ì§€ ì§„ì… ì‹œ ì´ì „ ê°’ ìë™ ì¡°íšŒ
           /* window.addEventListener("DOMContentLoaded", fetchMemberName);*/

        /*í˜¸í…Œë£¸ ì •ë³´ë¥¼ ê°€ì ¸ ì˜¤ëŠ” script*/
        let currentPage = 0;

        function loadHotelRooms(page = 0) {
            fetch(`/admin/hotelroom/listpage?page=${page}&size=6`)
                .then(res => res.json())
                .then(data => {
                    const listContainer = document.getElementById('hotelRoomList');
                    listContainer.innerHTML = '';

                    if (data.content.length === 0) {
                        listContainer.innerHTML = "<p>ë“±ë¡ëœ í˜¸í…”ë£¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
                        return;
                    }

                    data.content.forEach(room => {
                        const card = `
                        <div class="col-md-4 mb-3">
                            <div class="card" onclick="selectHotelRoom(${room.hotelRoomNum}, this)">
                                <img src="${room.hotelRoomProfileMeta}" class="card-img-top" alt="ë£¸ ì´ë¯¸ì§€" style="height:200px; object-fit:cover;">

                                <div class="card-body">
                                    <h5 class="card-title">${room.hotelRoomName}</h5>
                                    <p class="card-text">ì „í™”: ${room.hotelRoomPhone} / ê°€ê²©: ${room.hotelRoomPrice}</p>
                                </div>
                            </div>
                        </div>
                    `;
                        listContainer.insertAdjacentHTML('beforeend', card);
                    });

                    setupPagination(data);
                })
                .catch(err => {
                    console.error("í˜¸í…”ë£¸ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", err);
                });
        }

        function setupPagination(data) {
            const pagination = document.getElementById('hotelRoomPagination');
            pagination.innerHTML = '';

            for (let i = 0; i < data.totalPages; i++) {
                const btn = document.createElement('button');
                btn.type = 'button'; // ğŸ‘‰ ì´ê±° ì¶”ê°€
                btn.className = 'btn btn-sm mx-1 ' + (i === data.number ? 'btn-primary' : 'btn-outline-secondary');
                btn.innerText = i + 1;
                btn.onclick = () => loadHotelRooms(i);
                pagination.appendChild(btn);
            }
        }

        function selectHotelRoom(hotelRoomNum, element) {
            document.getElementById('hotelRoomNum').value = hotelRoomNum;

            const allCards = document.querySelectorAll('#hotelRoomList .card');
            allCards.forEach(card => card.classList.remove('border-primary'));
            element.classList.add('border-primary');
        }

        window.addEventListener('DOMContentLoaded', () => {
            fetchMemberName(); // ê¸°ì¡´ 1ë‹¨ê³„ í•¨ìˆ˜
            loadHotelRooms();  // í˜¸í…”ë£¸ í˜ì´ì§€ë„¤ì´ì…˜ í¬í•¨í•´ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
        });



    </script>

</div><!--ë ˆì´ì•„ì›ƒ fragment ëì§€ì -->
</body>
</html>
