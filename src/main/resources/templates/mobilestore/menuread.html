<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layoutmobile.html}">
<head>
    <meta charset="UTF-8">
    <title>메뉴 상세보기</title>
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
</head>
<body>
<div layout:fragment="contentorder" class="container py-4">
    <div style="display: none" th:text="${data.storeNum}" id="storeNum"></div>

    <div class="card mx-auto" style="max-width: 400px;">
        <div class="card-body text-center">
            <!-- 이미지 -->
            <div class="mb-3">
                <img th:if="${data.storemenuImgMeta != null}"
                     th:src="@{${data.storemenuImgMeta}}"
                     class="img-thumbnail rounded" style="width: 150px; height: 150px; object-fit: cover;">

                <img th:unless="${data.storemenuImgMeta != null}"
                     th:src="@{/store/menu/default.png}"
                     class="img-thumbnail rounded" style="width: 150px; height: 150px; object-fit: cover;">
            </div>

            <!-- 메뉴 이름 -->
            <h4 class="card-title mb-2" th:text="${data.storemenuName}">메뉴 이름</h4>

            <!-- 메뉴 설명 -->
            <p class="card-text text-muted" th:text="${data.storemenuContent}">메뉴 설명</p>

            <!-- 가격 -->
            <p class="fw-bold"><span th:text="${data.storemenuPrice}">0</span>원</p>

            <!-- 폼 시작 -->
            <form>
                <input th:value="${data.storemenuNum}" name="storemenuNum" type="hidden" readonly>

                <!-- 옵션들 -->
                <div class="text-start mb-3">
                    <label class="form-label fw-bold">추가 옵션</label>
                    <div th:each="option : ${data.storemenuOptionDTOList}" class="form-check">
                        <input class="form-check-input" type="checkbox"
                               name="storemenuOptions"
                               th:value="|${option.storemenuOptionNum}:${option.storemenuOptionName}:${option.storemenuOptionPrice}|">
                        <label class="form-check-label" th:for="'option-' + ${option.storemenuOptionNum}">
                            <span th:text="${option.storemenuOptionName}">옵션 이름</span>
                            (<span th:text="${option.storemenuOptionPrice}">0</span>원)
                        </label>
                    </div>
                </div>

                <!-- 수량 -->
                <div class="mb-3 text-start">
                    <label for="storecartitemCount" class="form-label fw-bold">수량</label>
                    <input id="storecartitemCount" name="storecartitemCount" type="number"
                           class="form-control" min="1" value="1" max="10">
                </div>
            </form>

            <!-- 장바구니 버튼 -->
            <button type="button" onclick="addcart()" class="btn btn-primary w-100 mt-2">
                장바구니 담기
            </button>
        </div>
    </div>

    <!-- 장바구니 스크립트 -->
    <script th:inline="javascript">
        function addcart() {
            const data = new FormData(document.querySelector("form"));
            const count = parseInt(document.querySelector("[name=storecartitemCount]").value);
            const storeNum = document.querySelector("#storeNum").textContent;

            if (isNaN(count) || count <= 0) {
                alert("수량을 1개 이상 입력하세요.");
                return;
            } else if (count>10){
                alert("한 번에 최대 10개의 상품만 담을 수 있습니다.")
                return;
            }

            fetch("/member/store/cart/insert", {
                method: "POST",
                body: data
            }).then(async response => {
                if (response.ok) {
                    alert("장바구니에 담았습니다!");
                    location.replace("/member/store/read/" + storeNum);
                } else if (response.status === 400) {
                    const text = await response.text();
                    if (text === "other") {
                        if (confirm("한 번에 하나의 가게에서만 주문할 수 있습니다. 장바구니를 비우고 담으시겠습니까?")) {
                            fetch("/member/store/cart/clear", {
                                method: "POST",
                                body: data
                            }).then(response => {
                                if (response.ok) {
                                    alert("장바구니에 담았습니다!");
                                    location.replace("/member/store/read/" + storeNum);
                                }
                            });
                        } else {
                            alert("문제가 발생했습니다. 다시 시도해 주세요.");
                        }
                    } else if (text === "over") {
                        alert("상품별로 최대 99개 까지 주문할 수 있습니다. 수량을 변경해주세요.")
                    } else {
                        alert("요청 처리 중 문제가 발생했습니다.")
                    }
                }
            });
        }
    </script>
</div>
</body>
</html>