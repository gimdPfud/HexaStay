<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout.html}">
<head>
    <meta charset="UTF-8">
    <title>매니지먼트 시스템</title>
</head>
<body>
<div layout:fragment="content">

    <style>
        /* 기존 CSS 스타일은 그대로 유지 */
        body {
            width: 100%;
            min-height: 100vh;
            background: linear-gradient(135deg, #dfe9f3, #ffffff);
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-sizing: border-box;
        }

        h5 {
            margin-bottom: 20px;
            color: #444;
            text-align: center;
            width: 100%;
        }

        .content-container {
            width: 100%;
            max-width: 700px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .profile-card {
            width: 100%;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            margin-bottom: 40px;
            display: flex;
            align-items: center; /* Vertically centers flex items */
            gap: 30px;
            box-sizing: border-box;
        }

        .profile-img {
            flex-shrink: 0;
            width: 120px;
            height: 150px;
        }

        .profile-img img {
            width: 100%;
            height: 100%;
            border: 5px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
            object-fit: cover; /* Ensures the image covers the area without distortion */
            display: block; /* Remove potential extra space below image */
        }

        .profile-info {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            color: #333;
        }

        .profile-info h5 {
            font-size: 24px;
            font-weight: bold;
            margin: 0 0 8px 0;
            color: #222;
            text-align: left;
        }

        .profile-info div {
            font-size: 16px;
            color: #555;
            margin-bottom: 5px;
            line-height: 1.4;
        }

        .profile-info div span {
            font-weight: 600;
            color: #333;
        }

        .profile-info .email span {
            font-weight: 600;
            color: #444;
        }

        .weather-row {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            width: 100%;
            box-sizing: border-box;
        }

        .weather-card-v2 {
            display: flex;
            width: 320px;
            height: 140px;
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            font-family: 'Segoe UI', sans-serif;
            flex-shrink: 0;
        }

        .icon-area {
            flex: 1;
            background-size: cover;
            background-position: center;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 100px;
            position: relative; /* PTY 이미지를 absolute로 배치하기 위한 기준 */
        }

        .icon-area img {
            width: 70px; /* 아이콘 크기 */
            height: 70px; /* 아이콘 크기 */
            z-index: 10; /* 아이콘이 배경 위에 오도록 */
            position: absolute; /* icon-area 기준 위치 조정 */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); /* 중앙 정렬 */
            object-fit: contain; /* 이미지 비율 유지 */
        }

        .info-area {
            flex: 1.5;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            color: #333;
        }

        .weather-title {
            font-size: 15px;
            color: #555;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .temp-info-line {
            font-size: 18px;
            color: #333;
            margin-bottom: 4px;
        }

        .temp-info-line .temp-label {
            font-size: 14px;
            color: #666;
            margin-right: 5px;
        }

        .temp-info-line .temp-value {
            font-size: 22px;
            font-weight: bold;
            color: #222;
        }
        .temp-info-line .temp-unit {
            font-size: 16px;
            color: #444;
            margin-left: 2px;
        }
    </style>

    <div class="content-container">
        <h5>오늘도 좋은 하루 보내세요!</h5>

        <div class="profile-card">
            <div class="profile-img">
                <img th:if="${#authentication.principal.adminProfileMeta != null}"
                     th:src="@{${#authentication.principal.adminProfileMeta}}"
                     alt="관리자 프로필 이미지">
                <img th:unless="${#authentication.principal.adminProfileMeta != null}"
                     th:src="@{/profile/default.png}"
                     alt="기본 프로필 이미지">
            </div>
            <div class="profile-info">
                <h5 th:text="${#authentication.principal.admin.adminName}">이름</h5>
                <div>직책: <span th:text="${#authentication.principal.admin.adminPosition}">직책</span></div>
                <div>직급: <span th:text="${#authentication.principal.adminRoleKorean}">직급</span></div>
                <div>Email: <span th:text="${#authentication.principal.admin.adminEmail}">이메일</span></div>
            </div>
        </div>

        <div class="weather-row">
            <div id="skyIconToday" class="weather-card-v2">
                <div class="icon-area">
                    <img id="ptyIconToday" src="" alt="Weather Icon">
                </div>
                <div class="info-area">
                    <div class="weather-title">오늘의 날씨</div>
                    <div class="temp-info-line">
                        <span class="temp-label">현재:</span> <span id="todayTMP" class="temp-value"></span><span class="temp-unit">°C</span>
                    </div>
                    <div class="temp-info-line">
                        <span class="temp-label">최고:</span> <span id="todayTMX" class="temp-value"></span><span class="temp-unit">°C</span>
                    </div>
                    <div class="temp-info-line">
                        <span class="temp-label">최저:</span> <span id="todayTMN" class="temp-value"></span><span class="temp-unit">°C</span>
                    </div>
                </div>
            </div>

            <div id="skyIconTomorrow" class="weather-card-v2">
                <div class="icon-area">
                    <img id="ptyIconTomorrow" src="" alt="Weather Icon">
                </div>
                <div class="info-area">
                    <div class="weather-title">내일의 날씨</div>
                    <div class="temp-info-line">
                        <span class="temp-label">최저:</span> <span id="tomorrowTMN" class="temp-value"></span><span class="temp-unit">°C</span>
                    </div>
                    <div class="temp-info-line">
                        <span class="temp-label">최고:</span> <span id="tomorrowTMX" class="temp-value"></span><span class="temp-unit">°C</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        //오늘 내일 날씨
        $(document).ready(function() {
            fetchWeatherData();
        });

        const fetchWeatherData = () => {
            const today = new Date();
            const yesterday = new Date();
            yesterday.setDate(today.getDate() - 1);
            const base_date = today.getHours() < 6 ?
                `${yesterday.getFullYear()}${String(yesterday.getMonth() + 1).padStart(2, '0')}${String(yesterday.getDate()).padStart(2, '0')}` :
                `${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}`;

            $.ajax({
                url: `https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getVilageFcst?serviceKey=wje5hA%2Bnn3R5RgOMpkRjQoneVn2py4RGqQmFJCCZS2IjYEetSvm7HP%2FngICVZN7%2FB0Mj2ig7Xp2oep7%2B4kcrSQ%3D%3D&pageNo=1&numOfRows=500&dataType=JSON&base_date=${base_date}&base_time=0500&nx=55&ny=127`,
                type: 'GET',
                success: function(data) {
                    let todayWeather = {}, tomorrowWeather = {};
                    let todayDateStr = `${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}`;
                    let tomorrow = new Date(today.getTime() + (24 * 60 * 60 * 1000));
                    let tomorrowDateStr = `${tomorrow.getFullYear()}${String(tomorrow.getMonth() + 1).padStart(2, '0')}${String(tomorrow.getDate()).padStart(2, '0')}`;

                    data.response.body.items.item.forEach(item => {
                        // 오늘 날짜 데이터 처리
                        if (item.fcstDate === todayDateStr) {
                            if (item.category === 'TMP') todayWeather.TMP = item.fcstValue;
                            if (item.category === 'TMX' && item.fcstTime === '1500') todayWeather.TMX = item.fcstValue; // 1500 시간의 TMX만
                            if (item.category === 'TMN' && item.fcstTime === '0600') {
                                // TMN 값이 있을 경우 그대로 사용
                                todayWeather.TMN = item.fcstValue;
                            } else if (item.category === 'TMP') {
                                // TMP 값을 배열에 저장하고, 나중에 최소값을 사용
                                if (!todayWeather.TMPs) todayWeather.TMPs = []; // TMPs 배열이 없으면 초기화
                                todayWeather.TMPs.push(parseFloat(item.fcstValue));
                            }

                            // 이후 모든 데이터를 처리한 후 최저 TMP 값을 TMN으로 설정
                            if (!todayWeather.TMN && todayWeather.TMPs && todayWeather.TMPs.length > 0) {
                                todayWeather.TMN = Math.min(...todayWeather.TMPs); // TMP 값 중 최저값을 TMN으로 사용
                            }

                            if (item.category === 'SKY') setSkyIcon(item.fcstValue, 'today');
                            if (item.category === 'PTY') setPtyIcon(item.fcstValue, 'today');
                        }

                        if (item.fcstDate === tomorrowDateStr) {
                            if (item.category === 'TMP') tomorrowWeather.TMP = item.fcstValue;
                            if (item.category === 'TMX' && item.fcstTime === '1500') tomorrowWeather.TMX = item.fcstValue; // 1500 시간의 TMX만
                            if (item.category === 'TMN' && item.fcstTime === '0600') tomorrowWeather.TMN = item.fcstValue; // 내일 TMN만

                            if (item.category === 'SKY') setSkyIcon(item.fcstValue, 'tomorrow');
                            if (item.category === 'PTY') setPtyIcon(item.fcstValue, 'tomorrow');
                        }
                    });

                    $('#todayTMP').text(todayWeather.TMP || '정보 없음');
                    $('#todayTMX').text(todayWeather.TMX || '정보 없음');
                    $('#todayTMN').text(todayWeather.TMN || '정보 없음');

                    $('#tomorrowTMP').text(tomorrowWeather.TMP || '정보 없음');
                    $('#tomorrowTMX').text(tomorrowWeather.TMX || '정보 없음');
                    $('#tomorrowTMN').text(tomorrowWeather.TMN || '정보 없음');
                },
                error: function() {
                    console.error('날씨 데이터를 가져오는 데 실패했습니다.');
                }
            });
        };

        function setSkyIcon(skyCode, day) {
            let skyDiv = document.getElementById(`skyIcon${day.charAt(0).toUpperCase() + day.slice(1)}`);
            switch (skyCode) {
                case '1': skyDiv.style.backgroundImage = 'url("/weatherimg/SKY1.png")'; break; // 맑음
                case '3': skyDiv.style.backgroundImage = 'url("/weatherimg/SKY3.png")'; break; // 구름많음
                case '4': skyDiv.style.backgroundImage = 'url("/weatherimg/SKY4.png")'; break; // 흐림
                default: skyDiv.style.backgroundImage = 'url("/weatherimg/SKY1.png")'; break;  // 이미지 없음
            }
            skyDiv.style.backgroundSize = "cover";
            skyDiv.style.backgroundSize = "100% 100%";
            skyDiv.style.boxSizing = "border-box";
            skyDiv.style.overflow = "hidden";
            skyDiv.style.zIndex = "1";
        }

        // 강수 상태에 따른 이미지 설정 함수
        function setPtyIcon(ptyCode, day) {
            let ptyImg = document.getElementById(`ptyIcon${day.charAt(0).toUpperCase() + day.slice(1)}`);

            switch (ptyCode) {
                case '0': ptyImg.src = '/weatherimg/PTY0.png'; break; // 강수 없음
                case '1': ptyImg.src = '/weatherimg/PTY1.png'; break; // 비
                case '2': ptyImg.src = '/weatherimg/PTY2.png'; break; // 비/눈
                case '3': ptyImg.src = '/weatherimg/PTY3.png'; break; // 눈
                case '4': ptyImg.src = '/weatherimg/PTY4.png'; break; // 소나기
                default: ptyImg.src = '/weatherimg/PTY0.webp'; break;  // 이미지 없음
            }
        }
    </script>

</div>
</body>
</html>